FROM --platform=linux/amd64 node:14 AS js_builder

COPY src/ /src
WORKDIR /src/UI/WB.UI.Frontend
RUN yarn && yarn build --package

FROM mcr.microsoft.com/dotnet/core/sdk:3.1 as builder

ARG GIT_BRANCH
ARG HQ_BUILD
ARG EXPORT_BUILD

ARG TARGETPLATFORM
ARG BUILDPLATFORM

RUN echo "Docker is running on $BUILDPLATFORM, building for $TARGETPLATFORM"

COPY libs /libs
COPY src /src

COPY --from=js_builder /src/UI/WB.UI.Frontend/dist/package/hq /src/UI/WB.UI.Headquarters.Core/

RUN dotnet publish /src/UI/WB.UI.Headquarters.Core \
    -c Release -o /hq \
    --version-suffix $GIT_BRANCH \
    /p:BuildNumber=$HQ_BUILD
RUN dotnet publish src/Services/Export/WB.Services.Export.Host \
    -c Release \
    -o /export \
    --version-suffix $GIT_BRANCH \
    /p:BuildNumber=$EXPORT_BUILD

FROM mcr.microsoft.com/dotnet/core/aspnet:3.1

ARG BUILD_DATE
ARG VCS_REF
ARG BUILD_VERSION
ARG GIT_BRANCH

ARG HQ_BUILD
ARG IN_BUILD
ARG SV_BUILD
ARG EXPORT_BUILD

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
    gdal-bin \
    ffmpeg \
    libfontconfig1 \
    libgdiplus \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Labels.
LABEL org.label-schema.schema-version="1.0"
LABEL org.label-schema.build-date=$BUILD_DATE
LABEL org.label-schema.name="headquarters with export"
LABEL org.label-schema.description="Survey Solutions headquarters application with embedded export service"
LABEL org.label-schema.url="https://mysurvey.solutions"
LABEL org.label-schema.vcs-ref=$VCS_REF
LABEL org.label-schema.vcs-url="https://github.com/surveysolutions/surveysolutions"
LABEL org.label-schema.version=$BUILD_VERSION
LABEL org.label-schema.usage="https://support.mysurvey.solutions/headquarters/config/${BUILD_VERSION}/docker"

LABEL solutions.mysurvey.hq.build-no=$HQ_BUILD
LABEL solutions.mysurvey.interviewer.build-no=$IN_BUILD
LABEL solutions.mysurvey.supervisor.build-no=$SV_BUILD
LABEL solutions.mysurvey.export.build-no=$EXPORT_BUILD

# Larger files at first
COPY build/headquarters/*.apk /app/Client/

COPY --from=builder hq /app
COPY --from=builder export /app/Export.Service

COPY build/headquarters/appsettings.ini /app/appsettings.cloud.ini

WORKDIR /app
EXPOSE 80
HEALTHCHECK --interval=5s --timeout=30s --start-period=2s --retries=3 CMD curl -l http://hq/.hc/ready

ENTRYPOINT ["dotnet", "WB.UI.Headquarters.dll"]
