FROM mcr.microsoft.com/dotnet/core/aspnet:3.1

RUN apt-get update \
    && apt-get install -y libfontconfig1 libgdiplus ffmpeg gdal-bin

ARG BUILD_DATE
ARG VCS_REF
ARG BUILD_VERSION

ARG HQ_BUILD
ARG IN_BUILD
ARG SV_BUILD
ARG EXPORT_BUILD

# Labels.
LABEL org.label-schema.schema-version="1.0"
LABEL org.label-schema.build-date=$BUILD_DATE
LABEL org.label-schema.name="headquarters with export"
LABEL org.label-schema.description="Survey Solutions headquarters application with embedded export service"
LABEL org.label-schema.url="https://mysurvey.solutions"
LABEL org.label-schema.vcs-ref=$VCS_REF
LABEL org.label-schema.vcs-url="https://github.com/surveysolutions/surveysolutions"
LABEL org.label-schema.version=$BUILD_VERSION
LABEL org.label-schema.usage="https://support.mysurvey.solutions/headquarters/config/$BUILD_VERSION}/docker"

LABEL solutions.mysurvey.hq.build-no=$HQ_BUILD
LABEL solutions.mysurvey.interviewer.build-no=$IN_BUILD
LABEL solutions.mysurvey.supervisor.build-no=$SV_BUILD
LABEL solutions.mysurvey.export.build-no=$EXPORT_BUILD

ADD headquarters.linux-x64.tar.gz /app/
ADD export.linux-x64.tar.gz /app/Export.Service
COPY appsettings.Production.ini /app/appsettings.cloud.ini

COPY *.apk /app/Client/

WORKDIR /app
EXPOSE 80
HEALTHCHECK --interval=30s --timeout=30s --start-period=10s --retries=3 CMD curl -l http://hq/.hc/ready

ENTRYPOINT ["dotnet", "WB.UI.Headquarters.dll", "--urls=http://0.0.0.0:80"]
