@{
    this.Layout = "~/Views/ControlPanel/Layout.ControlPanel.cshtml";
    this.ViewBag.Title = "Control Panel: Expression Generation";
}
<style type="text/css">
pre.wrap {
    white-space: pre-wrap;       
    white-space: -moz-pre-wrap;  
    white-space: -pre-wrap;      
    white-space: -o-pre-wrap;    
}
</style>

<h3>Questionnaire Expression Generation</h3>

<div class="well">
    <form class="form-horizontal">
        <div class="form-group">
            <label for="questionnaireId" class="col-xs-3 control-label">Questionnaire identifier</label>
            <div class="col-xs-9">
                <input id="questionnaireId" type="text" class="form-control" value="00000000-0000-0000-0000-000000000000" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-xs-offset-3 col-xs-9">
                <button id="generate" type="button" class="btn ">Generate single class</button>
                <button id="getPartial" type="button" class="btn ">Get a list</button>
                <button id="getCompilationResult" type="button" class="btn ">Get compilation result</button>
            </div>
        </div>
        <div class="form-group">
            <div class="col-xs-offset-3 col-xs-9">
                <button id="getAssembly" type="button" class="btn ">Get Assembly</button>
            </div>
        </div>
        <pre id="outputResult" class="help-block"></pre>
    </form>
</div>

<pre id="resultArea" class="wrap" style="height: 400px; overflow-y: scroll;"></pre>

@section scripts
{
    <script type="text/javascript">

        $(function() {

            $('#generate').click(function() {
                performPrettyAjaxRequest($('#outputResult'), {
                    type: 'GET',
                    url: '@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ExpressionGeneration", action = "GenerateExpressionsClassForLatestVersion" })',
                    data: { id: $('#questionnaireId').val() },
                });
            });

            $('#getPartial').click(function() {
                performPrettyAjaxRequest($('#outputResult'), {
                    type: 'GET',
                    url: '@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ExpressionGeneration", action = "GetAllClassesForLatestVersion" })',
                    data: { id: $('#questionnaireId').val() },
                });
            });

            $('#getAssembly').click(function() {
                $('#outputResult').text("sending request...");
                $('#resultArea').text("");
                downloadURL('@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ExpressionGeneration", action = "GetLatestVersionAssembly" })' + '?id=' + $('#questionnaireId').val())
            });

            $('#getCompilationResult').click(function () {
                $('#resultArea').text("");
                performPrettyAjaxRequest($('#outputResult'), {
                    type: 'GET',
                    url: '@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ExpressionGeneration", action = "GetCompilationResultForLatestVersion" })',
                    data: { id: $('#questionnaireId').val() },
                }, function(response) {
                    var errors = response.responseJSON;
                    var errorList = $('<ol></ol>');
                    $.each(errors, function(i) {
                        var li = $('<li/>')
                            .text(errors[i]);
                        errorList.append(li);
                    });
                    $('#resultArea').text("");
                    $('#resultArea').append(errorList);
                });
            });

            function performPrettyAjaxRequest($output, ajaxSettings, faildRequestProcessor) {
                $('button').attr('disabled', 'disabled');
                $output.text("sending request...");

                $.ajax(ajaxSettings
                ).done(function(result) {
                    $('#resultArea').text(result);
                    $output.text("done");
                }).fail(function(xhr, status, error) {
                    $output.text("failed: " + error + "\r\n" + getExceptionDetails(xhr));
                    if (faildRequestProcessor !== undefined) {
                        try {
                            faildRequestProcessor(xhr);
                        } catch (err) {
                        }
                    }
                }).always(function() {
                    $('button').removeAttr('disabled');
                });
            }

            function getExceptionDetails(xhr) {
                try {
                    return xhr.responseJSON.Message;
                } catch (e1) {
                    return xhr.responseText;
                }
            }

            var downloadURL = function downloadURL(url) {
                var hiddenIFrameID = 'hiddenDownloader',
                    iframe = document.getElementById(hiddenIFrameID);
                if (iframe === null) {
                    iframe = document.createElement('iframe');
                    iframe.id = hiddenIFrameID;
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }
                iframe.src = url;
            };


        });

    </script>
}

