<form role="form" id="question-editor" name="questionForm" unsaved-warning-form ng-show="activeQuestion">
    <div id="show-reload-details-promt" class="ng-cloak" ng-show="activeQuestion.shouldUserSeeReloadDetailsPromt">
        <div class="inner">Click <a ng-click="loadQuestion();" href="javascript:void(0);">reload</a> to update options</div>
    </div>
    <div class="form-holder">

        <div class="breadcrumbs-container">
            <div data-item-breadcrumbs data-crumbs="activeQuestion.breadcrumbs"></div>
        </div>

        <div class="row">
            <div class="form-group col-xs-6">
                <label class="wb-label">Question type</label><br>
                <div class="btn-group type-container-dropdown" uib-dropdown>
                    <button id="questionTypeBtn" class="btn btn-default form-control" uib-dropdown-toggle type="button">
                        <i class="icon {{answerTypeClass[activeQuestion.type]}}"></i>
                        <span class="vertical-line"></span>
                        {{activeQuestion.typeName}}
                        <span class="dropdown-arrow"></span>
                    </button>

                    <ul class="dropdown-menu " role="menu" aria-labelledby="questionTypeBtn">
                        <li role="presentation" ng-repeat="type in activeQuestion.questionTypeOptions">
                            <a role="menuitem" tabindex="-1" ng-click="setQuestionType(type.value)">
                                <i class="icon {{answerTypeClass[type.value]}}"></i>
                                {{type.text}}
                            </a>
                        </li>
                    </ul>
                </div>
                <input type="hidden" ng-model="activeQuestion.type" required />
            </div>

            <div class="form-group input-variable-name col-xs-5 pull-right">
                <label for="edit-question-variable-name" class="wb-label">Variable name<help key="variableName" placement="left" /></label><br />
                <input id="edit-question-variable-name" type="text" 
                       ng-model="activeQuestion.variable" 
                       spellcheck="false"
                       class="form-control" maxlength="32">
            </div>
        </div>
        <div class="form-group" ng-show="activeQuestion.type=='GpsCoordinates' && activeQuestion.questionScope == 'Prefilled'">
            <span class="edit-question-note">
                This question will be treated as GPS navigation question for Interviewer
            </span>
        </div>
        <div class="form-group">
            <label for="edit-variable-label" class="wb-label">Variable label<help key="variableLabel" /></label><br>
            <input id="edit-variable-label" type="text" ng-model="activeQuestion.variableLabel" class="form-control" maxlength="80">
        </div>

        <div class="form-group">
            <label for="edit-question-title" class="wb-label">Question text</label><br>
            <textarea id="edit-question-title" type="text" ng-model="activeQuestion.title" class="form-control" msd-elastic></textarea>

            <div class="question-type-specific-block"
                 ng-include="'views/question-details/' + activeQuestion.type + '-template.html'"
                 ng-if="activeQuestion.type != undefined
                 && (activeQuestion.type!='GpsCoordinates'
                 && activeQuestion.type!='QRBarcode'
                 && activeQuestion.type!='Multimedia')
                 ">
            </div>
        </div>
        <div class="form-group" ng-show="!((showInstruction===undefined && initialQuestion.instructions) || showInstruction)">
            <button type="button" class="btn btn-lg btn-link" ng-click="showInstruction=true">Add Interviewer Instruction</button>
        </div>

        <div class="row" ng-show="(showInstruction===undefined && initialQuestion.instructions) || showInstruction">
            <div class="form-group col-xs-11">
                <label for="edit-question-instructions">Instruction <help key="instruction" /></label>

                <input id="cb-hide-instructions" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.hideInstructions" />
                <label for="cb-hide-instructions"><span></span>Hide instruction <help key="hideInstructions" /></label>

                <textarea id="edit-question-instructions" ng-model="activeQuestion.instructions" class="form-control" msd-elastic></textarea>
            </div>

            <div class="form-group col-xs-1">
                <button type="button" class="btn cross instructions-cross"
                        ng-click="showInstruction=false;activeQuestion.instructions='';activeQuestion.hideInstructions=false;questionForm.$setDirty();"></button>
            </div>
        </div>

        <div class="form-group enabling-group" ng-hide="!doesQuestionSupportEnablementConditions()">
            <div class="enabling-group-marker"></div>
            <label for="edit-question-enablement-condition">Enabling condition <help key="conditionExpression" /></label>

            <input id="cb-hideIfDisabled" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.hideIfDisabled" />
            <label for="cb-hideIfDisabled"><span></span>Hide if disabled <help key="hideIfDisabled" /></label>

            <div class="pseudo-form-control">
                <div id="edit-question-enablement-condition" 
                     ui-ace="{ onLoad : aceLoaded, require: ['ace/ext/language_tools'] }" ng-model="activeQuestion.enablementCondition"></div>
            </div>
        </div>

        <div class="form-group validation-group" ng-if="doesQuestionSupportValidations()" ng-repeat="validation in activeQuestion.validationConditions" id="validationCondition{{$index}}">
            <div class="validation-group-marker"></div>
            <label>Validation condition {{$index + 1}} <help key="validationExpression" /></label>

            <button class="btn delete-btn-sm delete-validation-condition" ng-click="removeValidationCondition($index)" tabindex="-1"></button>

            <div class="pseudo-form-control">
                <div ui-ace="{ onLoad : aceLoaded, require: ['ace/ext/language_tools'] }" 
                     ng-attr-id="{{'validation-expression-' + $index}}"
                     ng-model="validation.expression" 
                     ng-attr-tabindex="{{$index + 1}}"></div>
            </div>

            <label for="validationMessage{{$index}}" class="validation-message">Error message <help key="validationMessage" /></label>
            <textarea id="validationMessage{{$index}}" ng-model="validation.message" ng-attr-tabindex="{{$index + 1}}"
                      class="form-control" msd-elastic maxlength="250"></textarea>
        </div>
        <div class="form-group" ng-if="doesQuestionSupportValidations() && activeQuestion.validationConditions.length < 10">
            <button type="button" class="btn btn-lg btn-link" ng-click="addValidationCondition()">Add new validation rule</button>
        </div>

    <div class="form-group">
        <div class="form-group pull-right">
            <label for="Question-scope">Question scope&nbsp;</label>
            <div class="btn-group dropup " uib-dropdown>
                <button class="btn dropdown-toggle" id="Question-scope" uib-dropdown-toggle type="button">
                    {{ activeQuestion.questionScope }}
                    <span class="dropdown-arrow"></span>
                </button>

                <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="dropdownMenu1">
                    <li role="presentation" ng-repeat="scope in getQuestionScopes(activeQuestion)">
                        <a role="menuitem" tabindex="-1" ng-click="changeQuestionScope(scope)">
                            {{scope.text}}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script type="text/ng-template" id="categorical-filter-expression">
        <div class="form-group" ng-if="!activeQuestion.isLinked && !activeQuestion.isCascade">
            <label class="wb-label" for="optionsFilterExpression">Filter</label>
            <div class="pseudo-form-control">
                <div id="optionsFilterExpression" ui-ace="{ onLoad : aceLoaded, require: ['ace/ext/language_tools'] }" ng-model="activeQuestion.optionsFilterExpression"></div>
            </div>
        </div>
    </script>

    <script type="text/ng-template" id="linkTemplate.html">
        <div id="sourceOfLinkedEntity" class="dropdown-with-breadcrumbs-and-icons">
            <input type="hidden" name="linkedToEntity" ng-model="activeQuestion.linkedToEntity" ng-required="true" />
            <label for="linkedEntitySource">Bind to list question or question from roster group</label>
            <div class="btn-group" uib-dropdown>
                <button class="btn dropdown-toggle" uib-dropdown-toggle id="linkedEntitySource" type="button">
                    <span class="select-placeholder" ng-if="(activeQuestion.linkedToEntity.title || '') == ''">Select question</span>

                    <span class="selected-item" ng-if="(activeQuestion.linkedToEntity.title || '') !== ''">
                        <span class="path">{{activeQuestion.linkedToEntity.breadcrumbs}}</span>
                        <span class="chosen-item" ng-if="activeQuestion.linkedToEntity.type!=='roster'">
                            <i class="dropdown-icon" ng-class="'icon-'+activeQuestion.linkedToEntity.type"></i>
                            {{activeQuestion.linkedToEntity.title}}  (<span class="var-name-line">{{activeQuestion.linkedToEntity.varName}}</span>)
                        </span>
                        <span class="linked-roster-source" ng-if="activeQuestion.linkedToEntity.type==='roster'">
                            {{activeQuestion.linkedToEntity.title}}  (<span class="var-name-line">{{activeQuestion.linkedToEntity.varName}}</span>)
                        </span>
                    </span>
                    <span class="dropdown-arrow"></span>
                </button>

                <ul class="dropdown-menu" role="menu">
                    <li role="presentation" ng-class="{'dropdown-header': breadCrumb.isSectionPlaceHolder}" ng-repeat="breadCrumb in sourceOfLinkedEntities track by $index">
                        <span ng-if="breadCrumb.isSectionPlaceHolder">{{::breadCrumb.title}}</span>

                        <a ng-if="!breadCrumb.isSectionPlaceHolder && breadCrumb.type==='roster'"
                            ng-click="setLinkSource(breadCrumb.id, activeQuestion.linkedFilterExpression)"
                            role="menuitem"
                            tabindex="-1"
                            class="linked-roster-source"
                            href="javascript:void(0);">
                            <div>
                                <i class="dropdown-icon icon-{{breadCrumb.questionType || 'none'}}"></i>
                                <span ng-bind-html="breadCrumb.title"></span>
                            </div>
                            <div class="var-block">
                                <span class="var-name" ng-bind-html="breadCrumb.varName"></span>
                            </div>
                        </a>

                        <a ng-if="!breadCrumb.isSectionPlaceHolder && breadCrumb.type!=='roster'"
                            ng-click="setLinkSource(breadCrumb.id, activeQuestion.linkedFilterExpression)"
                            role="menuitem"
                            tabindex="-1"
                            class="linked-question-source"
                            href="javascript:void(0);">
                            <div>
                                <i class="dropdown-icon icon-{{breadCrumb.type}}"></i>
                                <span ng-bind-html="breadCrumb.title"></span>
                            </div>
                            <div class="var-block">
                                <span class="var-name" ng-bind-html="breadCrumb.varName"></span>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>
            <p class="help-block ng-cloak" ng-show="questionForm.linkedToEntity.$error.required">
                You must bind this question
            </p>
            <hr />
            <label for="optionsFilterExpression">Filter</label>

            <div class="pseudo-form-control">
                <div id="optionsFilterExpression" ui-ace="{ onLoad : aceLoaded, require: ['ace/ext/language_tools'] }" ng-model="activeQuestion.linkedFilterExpression"></div>
            </div>
        </div>
    </script>
    </div>
    <div class="form-buttons-holder">
        <div class="pull-left">
            <button type="submit" ng-show="!questionnaire.isReadOnlyForUser" id="edit-chapter-save-button" class="btn btn-lg " ng-class="{ 'btn-primary': questionForm.$dirty }" unsaved-warning-clear ng-click="saveQuestion()" ng-disabled="!questionForm.$valid">Save</button>
            <button type="reset" id="edit-chapter-cancel-button" class="btn btn-lg btn-link" unsaved-warning-clear ng-click="cancelQuestion()">Cancel</button>
        </div>
        <div class="pull-right">
            <button type="button" ng-show="!questionnaire.isReadOnlyForUser" id="edit-chapter-delete-button" class="btn btn-lg btn-link" ng-click="deleteQuestion(activeQuestion)" unsaved-warning-clear>Delete</button>
            <ng-include src="'moveToChapterSnippet'" ng-show="!questionnaire.isReadOnlyForUser" />
        </div>
    </div>
</form>
