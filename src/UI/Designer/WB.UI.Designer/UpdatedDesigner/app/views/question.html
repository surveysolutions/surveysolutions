<form role="form" id="question-editor" name="questionForm" unsaved-warning-form>
    <div id="show-reload-details-promt" class="ng-cloak" ng-show="activeQuestion.shouldUserSeeReloadDetailsPromt">
        <div class="inner">Click <a ng-click="loadQuestion();" href="javascript:void(0);">reload</a> to update options</div>
    </div>
    <div class="form-holder">

        <div class="breadcrumbs-container"><div data-item-breadcrumbs data-crumbs="activeQuestion.breadcrumbs"></div></div>

        <div class="row">
            <div class="form-group col-xs-6">
                <label for="edit-group-title" class="wb-label">Question type</label><br>
                <div class="btn-group type-container-dropdown" dropdown>
                    <button id="questionTypeBtn" class="btn btn-default form-control" dropdown-toggle type="button">
                        <i class="icon {{answerTypeClass[activeQuestion.type]}}"></i>
                        <span class="vertical-line"></span>
                        {{activeQuestion.typeName}}
                        <span class="dropdown-arrow"></span>
                    </button>

                    <ul class="dropdown-menu " role="menu" aria-labelledby="questionTypeBtn">
                        <li role="presentation" ng-repeat="type in activeQuestion.questionTypeOptions">
                            <a role="menuitem" tabindex="-1" ng-click="setQuestionType(type.value)">
                                <i class="icon {{answerTypeClass[type.value]}}"></i>
                                {{type.text}}
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="form-group input-variable-name col-xs-5 pull-right">
                <label for="edit-question-variable-name" class="wb-label">Variable name<help key="variableName" placement="left" /></label><br />
                <input id="edit-question-variable-name" type="text" ng-model="activeQuestion.variable" spellcheck="false"
                       class="form-control" maxlength="32">
            </div>
        </div>
        <div class="form-group" ng-show="activeQuestion.type=='GpsCoordinates' && activeQuestion.questionScope == 'Prefilled'">
            <span class="edit-question-note">
                This question will be treated as GPS navigation question for Interviewer
            </span>
        </div>
        <div class="form-group">
            <label for="edit-variable-label" class="wb-label">Variable label<help key="variableLabel" /></label><br>
            <input id="edit-variable-label" type="text" ng-model="activeQuestion.variableLabel" class="form-control" maxlength="80">
        </div>

        <div class="form-group">
            <label for="edit-question-title" class="wb-label">Question text</label><br>
            <textarea id="edit-question-title" type="text" ng-model="activeQuestion.title" class="form-control" msd-elastic></textarea>

            <div class="question-type-specific-block"
                 ng-include="activeQuestion.type + '-template.html'"
                 ng-if="activeQuestion.type != undefined
                 && ( activeQuestion.type!='DateTime'
                 && activeQuestion.type!='GpsCoordinates'
                 && activeQuestion.type!='QRBarcode'
                 && activeQuestion.type!='Multimedia')
                 ">
            </div>
        </div>
        <div class="form-group" ng-show="!((showInstruction===undefined && initialQuestion.instructions) || showInstruction)">
            <button type="button" class="btn btn-lg btn-link" ng-click="showInstruction=true">Add Interviewer Instruction</button>
        </div>

        <div class="row" ng-show="(showInstruction===undefined && initialQuestion.instructions) || showInstruction">
            <div class="form-group col-xs-11">
                <label for="edit-question-instructions">Instruction <help key="instruction"/></label>

                <input id="cb-hide-instructions" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.hideInstructions"/>
                <label for="cb-hide-instructions"><span></span>Hide instruction</label>

                <textarea id="edit-question-instructions" ng-model="activeQuestion.instructions" class="form-control" msd-elastic></textarea>
            </div>

            <div class="form-group col-xs-1 pull-right">
                <button type="button" class="btn cross instructions-cross" ng-click="showInstruction=false;activeQuestion.instructions='';activeQuestion.hideInstructions=false;questionForm.$setDirty();"></button>
            </div>
        </div>

        <div class="form-group enabling-group" ng-hide="!doesQuestionSupportEnablementConditions()">
            <div class="enabling-group-marker"></div>
            <label for="edit-question-enablement-condition">Enabling condition <help key="conditionExpression" /></label>

                <input id="cb-hideIfDisabled" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.hideIfDisabled" />
                <label for="cb-hideIfDisabled"><span></span>Hide if disabled</label>

            <div class="pseudo-form-control">
                <div id="edit-question-enablement-condition" ui-ace="{ onLoad : aceLoaded }" ng-model="activeQuestion.enablementCondition"></div>
            </div>
        </div>

        <div class="form-group validation-group" ng-if="doesQuestionSupportValidations()" ng-repeat="validation in activeQuestion.validationConditions" id="validationCondition{{$index}}">
            <div class="validation-group-marker"></div>
            <label>Validation condition {{$index + 1}} <help key="validationExpression" /></label>

            <button class="btn delete-btn-sm delete-validation-condition" ng-click="removeValidationCondition($index)" tabindex="-1"></button>

            <div class="pseudo-form-control">
                <div ui-ace="{ onLoad : aceLoaded }" ng-model="validation.expression" ng-attr-tabindex="{{$index + 1}}"></div>
            </div>

            <label for="validationMessage{{$index}}" class="validation-message">Error message <help key="validationMessage" /></label>
            <textarea id="validationMessage{{$index}}" ng-model="validation.message" ng-attr-tabindex="{{$index + 1}}"
                      class="form-control" msd-elastic maxlength="250"></textarea>
        </div>
        <div class="form-group" ng-if="doesQuestionSupportValidations() && activeQuestion.validationConditions.length < 10">
            <button type="button" class="btn btn-lg btn-link" ng-click="addValidationCondition()">Add new validation rule</button>
        </div>

        <div class="form-group">
            <div class="form-group pull-right">
                <label for="Question-scope">Question scope&nbsp;</label>
                <div class="btn-group dropup " dropdown>
                    <button class="btn dropdown-toggle" id="Question-scope" dropdown-toggle type="button">
                        {{ activeQuestion.questionScope }}
                        <span class="dropdown-arrow"></span>
                    </button>

                    <ul class="dropdown-menu dropdown-menu-right" role="menu" aria-labelledby="dropdownMenu1">
                        <li role="presentation" ng-repeat="scope in getQuestionScopes(activeQuestion)">
                            <a role="menuitem" tabindex="-1" ng-click="changeQuestionScope(scope)">
                                {{scope.text}}
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

    <script type="text/ng-template" id="SingleOption-template.html">
            <div class="singleOption">
                <div class="well well-sm" ng-if="!(activeQuestion.isCascade || activeQuestion.isFilteredCombobox) && !activeQuestion.isLinked && activeQuestion.wereOptionsTruncated">As the question was marked as "Combo box" or "Cascading combo box" while uploading question's details and contained many options, it's value was reduced up to 200</div>
                <div ng-if="!activeQuestion.isFilteredCombobox && !activeQuestion.isLinked && !activeQuestion.isCascade">
                    <div ng-if="activeQuestion.useListAsOptionsEditor">
                        <div class="table-holder">
                            <div class="table-row question-options-editor" ng-repeat="option in activeQuestion.options">
                                <div class="column-2">
                                    <input type="text" ng-model="option.value" ng-keypress="onKeyPressInOptions($event)" class="form-control question-option-value-editor">
                                </div>
                                <div class="column-3">
                                    <input type="text" ng-model="option.title" ng-keypress="onKeyPressInOptions($event)" class="form-control">
                                </div>
                                <div class="column-4">
                                    <a href ng:click="removeOption($index)" class="btn" tabindex="-1"></a>
                                </div>
                            </div>
                        </div>
                        <p>
                            <button class="btn btn-link pull-right" ng-click="showOptionsInTextarea()">Show strings</button>
                            <button class="btn btn-link" ng-hide="activeQuestion.optionsCount >= MAX_OPTIONS_COUNT" ng-click="addOption()">Add Option</button>
                        </p>
                    </div>
                    <div ng-if="!activeQuestion.useListAsOptionsEditor">
                        <div class="form-group" ng-class="{'has-error': !questionForm.stringifiedOptions.$valid}">
                            <textarea name="stringifiedOptions"
                                      class="form-control mono"
                                      ng-model="activeQuestion.stringifiedOptions"
                                      match-options-pattern
                                      max-options-count
                                      msd-elastic></textarea>
                            <p class="help-block">
                                <input class="btn btn-link" type="button" value="Show list" ng-click="showOptionsInList()" ng-disabled="!questionForm.stringifiedOptions.$valid" />
                            </p>
                            <p class="help-block ng-cloak" ng-show="questionForm.stringifiedOptions.$error.matchOptionsPattern">
                                You entered an invalid input. Each line should follow the format: "Title...Value". 'Value' must be an integer or decimal number. Title must be an alpha-numeric string. No empty lines are allowed.
                            </p>
                            <p class="help-block ng-cloak" ng-show="questionForm.stringifiedOptions.$error.maxOptionsCount">
                                You entered more than maximum allowed 200
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <p>
                <a ng-if="activeQuestion.isFilteredCombobox"
                   href="javascript:void(0);"
                   class="btn btn-link"
                   ng-click="editFilteredComboboxOptions()">
                    Upload new options
                </a>
                <a ng-if="activeQuestion.isCascade && (activeQuestion.cascadeFromQuestionId || '') !== ''"
                   href="javascript:void(0);"
                   class="btn btn-link"
                   ng-click="editCascadingComboboxOptions()">
                    Upload new options
                </a>
            </p>
            <div class="table-holder">
                <div class="row">
                    <div class="col-xs-5" ng-if="!activeQuestion.isFilteredCombobox && !activeQuestion.isLinked">
                        <div  class="checkbox checkbox-in-column">
                            <input id="cb-is-cascading" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.isCascade" />
                            <label for="cb-is-cascading"><span></span>Cascading combo box</label>
                        </div>
                    </div>
                    <div class="col-xs-5" ng-if="!activeQuestion.isCascade && !activeQuestion.isLinked">
                        <div class="checkbox checkbox-in-column">
                            <input id="cb-is-filtered-combobox" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.isFilteredCombobox" />
                            <label for="cb-is-filtered-combobox"><span></span>Combo box</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-5">
                        <div ng-if="!activeQuestion.isFilteredCombobox && !activeQuestion.isCascade" class="checkbox checkbox-in-column">
                            <input id="cb-is-linked" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.isLinked" />
                            <label for="cb-is-linked"><span></span>Is linked</label>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div ng-if="!activeQuestion.isFilteredCombobox || !activeQuestion.isCascadingCombobox" class="form-group"
                     ng-include="activeQuestion.isLinked ? 'linkTemplate.html' : ''" ng-class="{'has-error': !questionForm.linkedToEntity.$valid}" />
            </div>

            <div>
                <div ng-if="activeQuestion.isCascade && !activeQuestion.isLinked"
                     ng-class="{'has-error': !questionForm.linkedToEntity.$valid}"
                     class="form-group" ng-include="'CascadingComboBox-Template.html'" />
            </div>
        </script>

    <script type="text/ng-template" id="linkTemplate.html">
            <div id="sourceOfLinkedEntity" class="dropdown-with-breadcrumbs-and-icons">
                <input type="hidden" name="linkedToEntity" ng-model="activeQuestion.linkedToEntity" ng-required="true" />
                <label for="linkedEntitySource">Bind to question from roster group</label>
                <div class="btn-group" dropdown>
                    <button class="btn dropdown-toggle" dropdown-toggle id="linkedEntitySource" type="button">
                        <span class="select-placeholder" ng-if="(activeQuestion.linkedToEntity.title || '') == ''">Select question</span>

                        <span class="selected-item" ng-if="(activeQuestion.linkedToEntity.title || '') !== ''">
                            <span class="path">{{activeQuestion.linkedToEntity.breadcrumbs}}</span>
                            <span class="chosen-item"  ng-if="activeQuestion.linkedToEntity.type!=='roster'"><i class="dropdown-icon" ng-class="'icon-'+activeQuestion.linkedToEntity.type"></i>{{activeQuestion.linkedToEntity.title}}</span>
                            <span class="linked-roster-source" ng-if="activeQuestion.linkedToEntity.type==='roster'">{{activeQuestion.linkedToEntity.title}}</span>
                        </span>
                        <span class="dropdown-arrow"></span>
                    </button>

                    <ul class="dropdown-menu" role="menu">
                        <li role="presentation" ng-class="{'dropdown-header': breadCrumb.isSectionPlaceHolder}" ng-repeat="breadCrumb in sourceOfLinkedEntities track by $index">
                            <span ng-if="breadCrumb.isSectionPlaceHolder">{{::breadCrumb.title}}</span>

                            <a ng-if="!breadCrumb.isSectionPlaceHolder && breadCrumb.type==='roster'"
                               ng-click="setLinkSource(breadCrumb.id, activeQuestion.linkedFilterExpression)"
                               role="menuitem"
                               tabindex="-1"
                               class="linked-roster-source"
                               href="javascript:void(0);">{{::breadCrumb.title}}</a>

                            <a ng-if="!breadCrumb.isSectionPlaceHolder&& breadCrumb.type!=='roster'"
                               ng-click="setLinkSource(breadCrumb.id, activeQuestion.linkedFilterExpression)"
                               role="menuitem"
                               tabindex="-1"
                               class="linked-question-source"
                               href="javascript:void(0);">
                                <i class="dropdown-icon" ng-class="'icon-'+breadCrumb.type"></i> {{::breadCrumb.title}}
                            </a>
                        </li>
                    </ul>
                </div>
                <p class="help-block ng-cloak" ng-show="questionForm.linkedToEntity.$error.required">
                    You must bind this question
                </p>
                <hr />
                <label for="linkedFilterExpression">Filter</label>
                
                <input id="linkedFilterExpression" type="text" ng-model="activeQuestion.linkedFilterExpression" class="form-control" style="border-color:#ccc;box-shadow: inset 0 1px 1px #ccc;">

            </div>
        </script>

        <script type="text/ng-template" id="CascadingComboBox-Template.html">
            <div id="sourceOfLinkedEntity" class="dropdown-with-breadcrumbs-and-icons">
                <input type="hidden" name="cascadeFromQuestionId" ng-model="activeQuestion.cascadeFromQuestionId" ng-update-hidden ng-required="true" />
                <label for="singleOptionQuestionSource">Select parent question</label>
                <div class="btn-group" dropdown>
                    <button class="btn dropdown-toggle" dropdown-toggle id="singleOptionQuestionSource" type="button">
                        <span class="select-placeholder" ng-if="(activeQuestion.cascadeFromQuestion.title || '') == ''">Select question</span>

                        <span class="selected-item" ng-if="(activeQuestion.cascadeFromQuestion.title || '') !== ''">
                            <span class="path">{{activeQuestion.cascadeFromQuestion.breadcrumbs}}</span>
                            <span class="chosen-item"><i class="dropdown-icon" ng-class="'icon-'+activeQuestion.cascadeFromQuestion.type"></i>{{activeQuestion.cascadeFromQuestion.title}}</span>
                        </span>
                        <span class="dropdown-arrow"></span>
                    </button>

                    <ul class="dropdown-menu" role="menu">
                        <li role="presentation" ng-class="{'dropdown-header': breadCrumb.isSectionPlaceHolder}" ng-repeat="breadCrumb in sourceOfSingleQuestions track by $index">
                            <span ng-if="breadCrumb.isSectionPlaceHolder">{{::breadCrumb.title}}</span>

                            <a ng-if="!breadCrumb.isSectionPlaceHolder"
                               ng-click="setCascadeSource(breadCrumb.id)"
                               role="menuitem"
                               tabindex="-1"
                               href="javascript:void(0);">
                                <i class="dropdown-icon" ng-class="'icon-'+breadCrumb.type"></i> {{::breadCrumb.title}}
                            </a>
                        </li>
                    </ul>
                </div>
                <p class="help-block ng-cloak" ng-show="questionForm.cascadeFromQuestionId.$error.required">
                    You must select the parent question
                </p>
            </div>
        </script>

        <script type="text/ng-template" id="MultyOption-template.html">
            <div class="multyOption">
                <div ng-if="!activeQuestion.isLinked">

                    <div ng-if="activeQuestion.useListAsOptionsEditor">
                        <div class="table-holder">
                            <div class="table-row question-options-editor" ng-repeat="option in activeQuestion.options">
                                <div class="column-2">
                                    <input type="text" ng-model="option.value" ng-keypress="onKeyPressInOptions($event)" class="form-control question-option-value-editor">
                                </div>
                                <div class="column-3">
                                    <input type="text" ng-model="option.title" ng-keypress="onKeyPressInOptions($event)" class="form-control">
                                </div>
                                <div class="column-4">
                                    <a href ng:click="removeOption($index)" class="btn"></a>
                                </div>
                            </div>
                        </div>
                        <p>
                            <button class="btn btn-link pull-right" ng-click="showOptionsInTextarea()">Show strings</button>
                            <button class="btn btn-link" ng-if="!activeQuestion.isLinked" ng-hide="activeQuestion.optionsCount >= MAX_OPTIONS_COUNT" id="edit-question-save-button" ng-click="addOption()">Add Option</button>
                        </p>
                    </div>
                    <div ng-if="!activeQuestion.useListAsOptionsEditor">
                        <div class="form-group" ng-class="{'has-error': !questionForm.stringifiedOptions.$valid}">
                            <textarea name="stringifiedOptions"
                                      class="form-control mono"
                                      ng-model="activeQuestion.stringifiedOptions"
                                      match-options-pattern
                                      maxoptionscount
                                      msd-elastic></textarea>
                            <p class="help-block">
                                <input class="btn btn-link" type="button" value="Show list" ng-click="showOptionsInList()" ng-disabled="!questionForm.stringifiedOptions.$valid" />
                            </p>
                            <p class="help-block ng-cloak" ng-show="questionForm.stringifiedOptions.$error.matchOptionsPattern">
                                You entered an invalid input. Each line should follow the format: "Title...Value". 'Value' must be an integer or decimal number. Title must be an alpha-numeric string. No empty lines are allowed.
                            <p class="help-block ng-cloak" ng-show="questionForm.stringifiedOptions.$error.maxOptionsCount">
                                You entered more than maximum allowed 200
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-holder">
                <div class="row">
                    <div class="col-xs-5">
                        <div class="checkbox checkbox-in-column">
                            <input id="cb-is-ordered" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.areAnswersOrdered" />
                            <label for="cb-is-ordered"><span></span>Record answer order</label>
                        </div>
                    </div>
                    <div class="col-xs-6">
                        <div class="form-group singleline-group checkbox-in-column" ng-class="{'has-error': !questionForm.editQuestionMaxAnswersNumber.$valid}">
                            <label for="edit-question-max-answers-number">Max number of answers</label>
                            <input maxlength="9" name="editQuestionMaxAnswersNumber" ng-pattern="/^\d+$/" id="edit-question-max-answers-number" type="text" class="form-control small-numeric-input" ng-model="activeQuestion.maxAllowedAnswers">
                            <p class="help-block ng-cloak" ng-show="questionForm.editQuestionMaxAnswersNumber.$error.pattern">
                                Only integers are allowed
                            </p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-4">
                        <div class="checkbox checkbox-in-column" ng-show="!activeQuestion.isLinked">
                            <input id="cb-multyoption-yes-no-view" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.yesNoView" />
                            <label for="cb-multyoption-yes-no-view"><span></span>Yes/No mode</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-4" ng-show="!activeQuestion.yesNoView">
                        <div class="checkbox checkbox-in-column">
                            <input id="cb-multyoption-is-linked" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.isLinked" />
                            <label for="cb-multyoption-is-linked"><span></span>Is linked</label>
                        </div>
                    </div>
                </div>

            <div class="form-group" ng-include="activeQuestion.isLinked ? 'linkTemplate.html' : ''" ng-class="{'has-error': !questionForm.linkedToEntity.$valid}">
            </div>
            </div>
        </script>

    <script type="text/ng-template" id="Numeric-template.html">
            <div class="row">
                <div class="col-xs-2">
                    <div class="checkbox checkbox-in-column">
                        <input id="cb-is-integer" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.isInteger" ng-change="isIntegerChange()" />
                        <label for="cb-is-integer"><span></span>Integer</label>
                    </div>
                </div>
                <div class="col-xs-4 inline-inputs">
                    <div class="checkbox checkbox-in-column">
                        <input id="cb-use-formatting" type="checkbox" class="wb-checkbox" ng-model="activeQuestion.useFormatting" />
                        <label for="cb-use-formatting"><span></span>Use formatting</label>
                        <help key="useFormatting"></help>
                    </div>
                </div>
                <div class="col-xs-6 inline-inputs">
                    <div class="form-group checkbox-in-column" ng-show="!activeQuestion.isInteger" ng-class="{'has-error': !questionForm.countOfDecimalPlaces.$valid}">
                        <label for="edit-question-count-decimal">Number of decimal places</label>
                        <input id="edit-question-count-decimal" type="text"
                               maxlength="15"
                               name="countOfDecimalPlaces"
                               ng-pattern="/^\d+$/"
                               ng-model="activeQuestion.countOfDecimalPlaces"
                               class="form-control small-numeric-input">
                        <p class="help-block ng-cloak" ng-show="questionForm.countOfDecimalPlaces.$error.pattern">
                            Only integers are allowed
                        </p>
                    </div>
                </div>
            </div>
        </script>

        <script type="text/ng-template" id="Text-template.html">
            <div class="form-group">
                <label for="edit-mask">Pattern <help key="mask" /></label>
                <input id="edit-mask" type="text" ng-model="activeQuestion.mask" class="form-control">
            </div>
        </script>

        <script type="text/ng-template" id="TextList-template.html">
            <div class="form-group" ng-class="{'has-error': !questionForm.maxAnswerCount.$valid}">
                <label for="edit-question-max-answers-number">Maximum number of list elements</label>
                <input id="edit-question-max-answers-number"
                       name="maxAnswerCount"
                       type="text"
                       ng-pattern="/^\d+$/"
                       ng-model="activeQuestion.maxAnswerCount"
                       class="form-control" />
                <p class="help-block ng-cloak" ng-show="questionForm.maxAnswerCount.$error.pattern">
                    Only integers are allowed
                </p>
            </div>
        </script>

        <script type="text/ng-template" id="DateTime-template.html">
        </script>

        <script type="text/ng-template" id="GpsCoordinates-template.html">
        </script>

        <script type="text/ng-template" id="QRBarcode-template.html">
        </script>

        <script type="text/ng-template" id="Multimedia-template.html">
        </script>
    </div>
    <div class="form-buttons-holder">
        <div class="pull-left">
            <button type="submit" ng-show="!questionnaire.isReadOnlyForUser" id="edit-chapter-save-button" class="btn btn-lg " ng-class="{ 'btn-primary': questionForm.$dirty }" unsaved-warning-clear ng-click="saveQuestion()" ng-disabled="!questionForm.$valid">Save</button>
            <button type="reset" id="edit-chapter-cancel-button" class="btn btn-lg btn-link" unsaved-warning-clear ng-click="cancelQuestion()">Cancel</button>
        </div>
        <div class="pull-right">
            <button type="button" ng-show="!questionnaire.isReadOnlyForUser" id="edit-chapter-delete-button" class="btn btn-lg btn-link" ng-click="deleteQuestion(activeQuestion)" unsaved-warning-clear>Delete</button>
            <ng-include src="'moveToChapterSnippet'" ng-show="!questionnaire.isReadOnlyForUser" />
        </div>
    </div>
</form>
