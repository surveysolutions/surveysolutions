<section id="header" class="row">
    <a class="designer-logo" href="../../"></a>
    <div class="header-line">
        <div class="header-menu">
            This document is <strong>{{questionnaire.isPublic ? 'public' : 'private'}}</strong>
            <div class="buttons">
                <a class="btn" href="../../questionnaire/questionnairehistory/{{questionnaire.questionnaireId}}" target="_blank">History</a>
                <button class="btn" type="button" ng-disabled="questionnaire.isReadOnlyForUser" ng-click="showShareInfo()">Settings</button>
                <a class="btn" href="../../account/logoff">LOG OUT</a>
            </div>
        </div>
        <div class="questionnarie-title">
            <div class="title">
                <div class="questionnarie-title-text">
                    {{questionnaire.title}}
                </div>
                <div class="questionnarie-title-buttons">
                    <span class="text-muted">({{questionnaire.questionsCount}}Q, {{questionnaire.groupsCount}}G, {{questionnaire.rostersCount}}R)</span>
                    <input id="verification-btn" type="button" class="btn" value="COMPILE" ng-click="verify()" />
                    <span id="verify-btn" data-toggle="modal" ng-show="verificationStatus.errorsCount" class="error-message ng-hide">
                        <a href="javascript:void(0);"
                           ng-click="verificationStatus.visible = true"
                           ng-pluralize
                           count="verificationStatus.errorsCount"
                           when="{'1': '{} error',
                          '100' : '{}+ errors',
                          'other': '{} errors'}">
                        </a>
                    </span>
                    <span class="text-success" ng-show="verificationStatus.errorsCount === 0">OK<em>, saved at <span>{{verificationStatus.time | date:'H:mm'}}</span></em></span>

                    <span class="error-message strong" ng-show="questionnaire.isReadOnlyForUser">Read Only</span>

                </div>
            </div>
        </div>
    </div>

</section>

<section id="spacer" class="row">
    <div class="left"></div>
    <div class="right"></div>
</section>

<section id="main" class="row">
    <div class="left-side-panel chapters" ng-class="{unfolded: isFolded }" ng-controller="ChaptersCtrl" data-empty-place-holder-enabled="false">
        <div class="foldback-region" ng-click="foldback();$event.stopPropagation()"></div>
        <div class="chapter-panel" ui-tree="chaptersTree">
            <div class="foldback-button" ng-click="foldback();$event.stopPropagation()"></div>
            <div class="ul-holder">
                <div class="chapters">
                    <perfect-scrollbar class="scroller">
                        <h3><span ng-show="questionnaire.chapters.length!=0">{{questionnaire.chapters.length}}</span> Section<span ng-show="questionnaire.chapters.length!=1">s</span>:</h3>
                        <ul ui-tree-nodes ng-model="questionnaire.chapters" class="chapters-list">
                            <li class="chapter-panel-item"
                                ng-repeat="chapter in questionnaire.chapters"
                                ui-tree-node
                                ng-class="{ current: isCurrentChapter(chapter) }"
                                context-menu data-target="chapter-context-menu-{{ chapter.itemId }}"
                                context-menu-hide-on-mouse-leave="true">
                                <div class="holder" ng-click="editChapter(chapter);$event.stopPropagation();">
                                    <div class="inner">
                                        <a class="handler" ui-tree-handle><span></span></a>
                                        <a class="chapter-panel-item-body" ui-sref="questionnaire.chapter.group({ chapterId: chapter.itemId, itemId: chapter.itemId})">{{chapter.title}}</a>
                                    </div>
                                </div>
                                <div class="dropdown position-fixed" id="chapter-context-menu-{{ chapter.itemId }}">
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a ng-click="editChapter(chapter);$event.stopPropagation();">Edit</a></li>
                                        <li><a ng-click="cloneChapter(chapter.itemId);$event.stopPropagation();">Clone</a></li>
                                        <li><a ng-click="copyRef(chapter);">Copy</a></li>
                                        <li>
                                            <a ng-disabled="!readyToPaste" ng-click="pasteAfterChapter(chapter);$event.stopPropagation();">Paste after</a>

                                        </li>
                                        <li><a ng-click="deleteChapter(chapter);$event.stopPropagation();">Delete</a></li>
                                    </ul>
                                </div>
                            </li>
                        </ul>
                        <div class="button-holder">
                            <input type="button" class="btn lighter-hover" value="ADD NEW SECTION" ng-click="addNewChapter()">
                        </div>
                    </perfect-scrollbar>
                </div>
            </div>
        </div>
    </div>
    <div class="left-side-panel macroses" ng-class="{unfolded: isFolded }" ng-controller="MacrosCtrl" data-empty-place-holder-enabled="false">
        <div class="foldback-region" ng-click="foldback();$event.stopPropagation()"></div>
        <div class="macros-panel">
            <div class="foldback-button-region" ng-click="foldback();$event.stopPropagation()">
                <div class="foldback-button"></div>
            </div>
            <div class="macroses">
                <perfect-scrollbar class="scroller">
                    <h3><span ng-show="macros.length!=0">{{macros.length}}</span> Macro<span ng-show="macros.length!=1" >s</span>:</h3>
                    <form role="form" name="macrosForm" novalidate>
                        <ul ng-model="macros">
                            <li class="macros-panel-item" ng-repeat="macro in macros">
                                <ng-form name="macroForm">
                                    <a href ng-click="deleteMacro($index)" class="btn" tabindex="-1"></a>
                                    <div class="input-group macros-name">
                                        <span class="input-group-addon">$</span>
                                        <input focus-on-out="focusMacro{{macro.itemId}}" placeholder="macro name" maxlength="32" spellcheck="false" ng-model="macro.name" name="name" class="form-control" type="text"/>
                                    </div>
                                    <div class="divider"></div>
                                    <input placeholder="content" ng-model="macro.content" ui-ace="{ onLoad : aceLoaded }" class="form-control" type="text"/>
                                    <div ng-show="macro.isDescriptionVisible">
                                        <div class="divider"></div>
                                        <textarea placeholder="description" type="text" ng-model="macro.description" class="form-control macros-description" msd-elastic></textarea>
                                    </div>
                                    <div class="actions" ng-show="macroForm.$dirty">
                                        <button type="submit" ng-disabled="macroForm.$invalid" class="btn lighter-hover" ng-click="saveMacro(macro, macroForm)">Save</button>
                                        <button type="button" class="btn lighter-hover" ng-click="cancel(macro, macroForm)">Cancel</button>
                                        <button class="btn btn-default pull-right" ng-show="isDescriptionEmpty(macro)"  type="button" ng-click="toggleDescription(macro)">{{ macro.isDescriptionVisible? "hide" : "add" }} description</button>
                                    </div>
                                </ng-form>
                            </li>
                        </ul>

                    </form>
                    <div class="button-holder">
                        <input type="button" class="btn lighter-hover" value="ADD NEW Macro" ng-click="addNewMacro()">
                    </div>
                </perfect-scrollbar>
            </div>
        </div>
    </div>
    <div id="left-menu" ng-controller="LeftMenuCtrl">
        <ul>
            <li><a class="left-menu-chapters" ng-class="{unfolded: isFoldedChapters }" ng-click="unfoldChapters();"></a></li>
            <li><a class="left-menu-macroses" ng-class="{unfolded: isFoldedMacros }" ng-click="unfoldMacros();"></a></li>
        </ul>
    </div>

    <div class="questionnaire-tree" ui-view></div>
</section>

<div id="verification-modal" ng-show="verificationStatus.visible">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                Compilation: <span ng-pluralize count="verificationStatus.errorsCount"
                                   when="{'1': '{} error found', '100': '{}+ errors found', 'other': '{} errors found'}"></span>
            </h3>
            <button type="button" class="close" ng-click="verificationStatus.visible = false" aria-hidden="true"> <!--&times;--> </button>
        </div>
        <div class="modal-body">
            <perfect-scrollbar class="scroller">
                <div id="verify-popover-content">
                    <div class="question-list">
                        <div ng-repeat="error in verificationStatus.errors">
                            <div class="error-message"><span class="error-code">[{{error.code}}]:</span>{{error.message}}</div>
                            <ul class="verification-items" ng-class="{singleError: !error.isGroupedMessage}">
                                <li class="verification-item-container" ng-repeat="reference in error.references" ng-click="navigateTo(reference)">
                                    <a class="verification-item" href="javascript:void(0);">
                                        <span ng-if="reference.type == 'Question'" class="icon icon-error {{reference.questionType}}"></span>
                                        <span ng-if="reference.type == 'Macro'" class="icon icon-error icon-macro"></span>
                                        <span ng-if="reference.type == 'StaticText'" class="icon icon-error icon-statictext"></span>
                                        <span class="title">{{reference.title}}</span>
                                        <span ng-if="reference.type == 'Question' || reference.type == 'Roster' || reference.type == 'Macro'" class="variable" ng-bind="reference.variable">aaaa</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </perfect-scrollbar>
        </div>
        <div class="modal-footer">
            <button class="btn btn-link" ng-click="verify()">RECOMPILE</button>
            <button class="btn btn-link" data-dismiss="modal" ng-click="verificationStatus.visible = false">CLOSE</button>
        </div>
    </div>
</div>

<script type="text/ng-template" id="moveToChapterSnippet">
    <div class="btn-group dropup">
        <button type="button" class="btn btn-link dropdown-toggle" data-toggle="dropdown">
            Move to <span class="caret"></span>
        </button>

        <div role="menu" class="chapter-menu dropdown-menu dropdown-menu-right">
            <h1>Move to another sub-section:</h1>
            <ul>
                <li ng-repeat="chapter in $parent.questionnaire.chapters">
                    <a ng-click="chapter.itemId == currentChapterId || moveToChapter(chapter.itemId)" ng-disabled="chapter.itemId == currentChapterId" unsaved-warning-clear>
                        {{chapter.title}}
                    </a>
                </li>
            </ul>
        </div>
    </div>
</script>