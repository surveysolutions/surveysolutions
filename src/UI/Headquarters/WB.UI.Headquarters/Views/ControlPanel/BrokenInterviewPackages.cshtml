@using System.Web.Optimization
@using WB.Core.GenericSubdomains.Portable
@using WB.Core.GenericSubdomains.Utils
@using WB.Core.SharedKernels.DataCollection.ValueObjects.Interview
@using WB.Core.SharedKernels.SurveyManagement.Web.Code
@{
    this.Layout = "~/Views/Shared/_ControlPanelLayout.cshtml";
    this.ViewBag.Title = "Control Panel: Broken interview packages";
}


@section scripts
{
    @Styles.Render("~/Content/bootstrap-datepicker3.css", "~/Scripts/dateRangePicker/daterangepicker.css")
    @Styles.Render("~/css/list")
    @Scripts.Render("~/js/list", "~/js/brokeninterviewpackages")
    <script type="text/javascript">
        var $interviewPageUrl = '@Html.Raw(@Url.Action("Details", "Interview", new {area = ""}, Request.Url.Scheme))';
        var controlPanelBrokenInperviewPackagesUrl = '@Html.Raw(@Url.Action("BrokenInterviewPackages", "ControlPanel", new { }, Request.Url.Scheme))';
        var brokenInperviewPackagesUrl = '@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ControlPanelApi", action = "GetBrokenInterviewPackages" })';
        var exceptionTypesUrl = '@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ControlPanelApi", action = "GetBrokenInterviewPackageExceptionTypes" })';
        var responsiblesUrl = '@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ControlPanelApi", action = "Interviewers" })';
        var questionnairesUrl = '@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ControlPanelApi", action = "Questionnaires" })';
        var reprocessUrl = '@Url.RouteUrl("DefaultApiWithAction", new { httproute = "", controller = "ControlPanelApi", action = "ReprocessBrokenPackages" })';
        $(function () {
            var viewModel = new Supervisor.VM.ControlPanel.BrokenInterviewPackages(brokenInperviewPackagesUrl, controlPanelBrokenInperviewPackagesUrl, exceptionTypesUrl, responsiblesUrl, questionnairesUrl, reprocessUrl);
            viewModel.load();
            ko.applyBindings(viewModel);
        });
    </script>
}

<div class="page-header">
    <h3>
        <div class="row">
            <div class="col-md-9">Broken interview packages</div>
            <div class="col-md-3">
                <div class="pull-right">
                    <button type="submit" class="btn btn-primary inline-inputs" data-bind="click: reprocessAll">
                        <span class="glyphicon glyphicon-cog" aria-hidden="true"></span> &nbsp; Reprocess All
                    </button>
                </div>
            </div>
        </div>
    </h3>
</div>
<div class="panel panel-default">
    <div class="panel-body">
        <div class="btn-group">
            <div class="form-inline">
                <div class="input-group">
                    <select data-bind="value: SelectedQuestionnaire" class="form-control">
                        <option value="">Any</option>
                        <!-- ko foreach:Questionnaires -->
                        <option data-bind="value:Identity, text: Title"></option>
                        <!-- /ko -->
                    </select>
                </div>
                <div class="input-group">
                    <input class="form-control" placeholder="Any" data-bind="typeahead: SelectedResponsible, typeaheadOptions: {source: Responsibles, displayText: function(item){return item.UserName}}, valueupdate:'afterkeydown'" type="text" />
                    <span data-bind="spinner: IsResponsiblesLoading, spinnerOptions: { 'left': 1, 'right': '50px' }"></span>
                    <div class="input-group-btn" data-bind="click: function(){ SelectedResponsible(undefined); }">
                        <div class="btn btn-default"><span class=" glyphicon glyphicon-remove" aria-hidden="true"></span></div>
                    </div>
                </div>
                <div class="input-group">
                    <input class="form-control" placeholder="Exception type" data-bind="typeahead: SelectedExceptionType, typeaheadOptions: {source: ExceptionTypes, displayText: function(item){return item}}, valueupdate:'afterkeydown'" type="text" />
                    <span data-bind="spinner: IsExceptionTypesLoading, spinnerOptions: { 'left': 1, 'right': '50px' }"></span>
                    <div class="input-group-btn" data-bind="click: function(){ SelectedExceptionType(undefined); }">
                        <div class="btn btn-default"><span class=" glyphicon glyphicon-remove" aria-hidden="true"></span></div>
                    </div>
                </div>
                <div class="input-group" id="dates-range">
                    <input type="text" class="form-control" data-bind="value: SelectedProcessingDateRange" readonly="readonly" />
                    <span style="cursor: pointer" class="input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="list">
    <!-- ko if:IsPageLoaded()  -->
    <p class="text-center" data-bind="visible: Pager().TotalItemCount() == 0">
        No results found
    </p>
    <!-- /ko -->
    <div class="horizontal-scroll" data-bind="visible: Pager().TotalItemCount() > 0">
        <table class="table table-striped table-bordered table-condensed table-hover table-break-words">
            <thead>
                <tr>
                    <th data-bind='sortby: "InterviewId"' style="width: 1px" nowrap>Interview</th>
                    <th data-bind='sortby: "IncomingDate"' style="width: 1px" nowrap>Incoming date</th>
                    <th data-bind='sortby: "ProcessingDate"' style="width: 1px" nowrap>Processing date</th>
                    <th data-bind='sortby: "PackageSize"' style="width: 90px" nowrap>Size</th>
                    <th data-bind='sortby: "ExceptionType"' style="width: 200px" nowrap>Exception type</th>
                    <th data-bind='sortby: "ExceptionMessage"'>Exception</th>
                </tr>
            </thead>
            <tbody>
                <!-- ko foreach:Items -->
                <tr>
                    <td nowrap>
                        <a data-bind="attr: { href: $interviewPageUrl + '/' + InterviewId() }, text: InterviewId"></a>
                    </td>
                    <td data-bind="text: IncomingDate" nowrap></td>
                    <td data-bind="text: ProcessingDate" nowrap></td>
                    <td data-bind="text: $root.formatBytes(PackageSize())" nowrap style="text-align: right"></td>
                    <td data-bind="text: ExceptionType" nowrap></td>
                    <td>
                        <div class="accordion-group accordion-caret" style="max-width: 700px">
                            <div class="accordion-heading">
                                <a class="accordion-toggle collapsed" data-toggle="collapse" data-bind="attr:{ href: '#'+ Id()}">
                                    <strong data-bind="text: ExceptionMessage"></strong>
                                </a>
                            </div>
                            <div class="accordion-body collapse" data-bind="attr:{ id: Id}">
                                <pre class="accordion-inner margin-left10" data-bind="text: ExceptionStackTrace"></pre>
                            </div>
                        </div>
                    </td>
                </tr>
                <!-- /ko -->
            </tbody>
        </table>
    </div>
    <!-- ko if:Pager().LastPage() > 1 -->
    <div class="pagination pagination-right" data-bind="template: { name: 'tpl-pager', data: Pager }"></div>
    <!-- /ko -->
</div>

@Html.Partial("_ListViewPagingScript")
