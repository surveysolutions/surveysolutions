@using Microsoft.Practices.ServiceLocation
@using WB.Core.BoundedContexts.Headquarters.Services
@using WB.Core.BoundedContexts.Headquarters.Views.User

@model WB.Core.SharedKernels.SurveyManagement.Web.Models.InterviewersModel
    
@{
    Layout = "~/Views/Shared/_MainLayout.cshtml";
    ViewBag.Title = Pages.Interviewers_Title;
    var authorizedUser = ServiceLocator.Current.GetInstance<IAuthorizedUser>();
}

@{ bool isVisibleSupervisorColumn = authorizedUser.IsHeadquarter || authorizedUser.IsAdministrator; }
@{ bool isAdmin = authorizedUser.IsAdministrator; }


@section scripts
{
    @Scripts.Render("~/js/main-no-libs")
    @Scripts.Render("~/js/list")
    @Scripts.Render("~/js/interviewers")
    @Scripts.Render("~/js/common")

    <script type="text/javascript">
        'use strict';

        Supervisor.VM.InterviewersNew = function (listViewUrl,
            archiveUsersUrl,
            interviewersPageUrl,
            supervisorsUrl,
            ajax,
            notifier) {
            Supervisor.VM.InterviewersNew.superclass.constructor.apply(this, []);

            var self = this;

            self.Url = new Url();
            self.SupervisorUrl = supervisorsUrl;
            self.IsSupervisorsLoading = ko.observable(false);
            self.Supervisors = function(query, sync, pageSize) {
                self.IsSupervisorsLoading(true);
                self.SendRequest(self.SupervisorUrl,
                    { query: query, pageSize: pageSize, showLocked: true },
                    function(response) {
                        sync(response.Users, response.TotalCountByQuery);
                    },
                    true,
                    true,
                    function() {
                        self.IsSupervisorsLoading(false);
                    });
            }
            self.SelectedSupervisor = ko.observable();

            self.Archived = ko.observable(false);
            self.InterviewerOptionFilter = ko.observable('');

            self.SelectedItems = ko.observableArray([]);

            self.getConfirmAndSendRequest = function(confirmMessage, archive) {
                notifier.confirm("@Pages.ConfirmationNeededTitle",
                    confirmMessage,
                    // confirm
                    function() {
                        var request = {
                            userIds: self.SelectedItems(),
                            archive: archive
                        };

                        ajax.sendRequest(archiveUsersUrl, "post", request, false,
                            // onSuccess
                            function (data) {
                                var failedCommands = ko.utils.arrayFilter(data.CommandStatuses, function (cmd) {
                                    return !cmd.IsSuccess;
                                });

                                if (failedCommands.length > 0) {
                                    var failedDomainExceptions = ko.utils.arrayMap(failedCommands, function (failedCommand) {
                                        if (!Supervisor.Framework.Objects.isUndefined(failedCommand.DomainException) && failedCommand.DomainException !== null)
                                            return failedCommand.DomainException;
                                        else {
                                            return input.settings.messages.unhandledExceptionMessage;
                                        }
                                    });

                                    $.each(failedDomainExceptions, function (index, message) {
                                        notifier.showError("@Pages.OperationFailedTitle", message);
                                    });
                                }

                                self.updater();
                            });
                    },
                    // cancel
                    function() {});
            }

            self.unarchiveInterviewers = function() {
                self.getConfirmAndSendRequest("@Archived.UnarchiveInterviewerWarning \r\n @Pages.Interviewers_ArchiveInterviewersConfirm", false);
            };

            self.archiveInterviewers = function() {
                self.getConfirmAndSendRequest("@Pages.Interviewers_ArchiveInterviewersConfirmMessage", true);
            }

            self.updater = function() {};

            self.load = function(updater) {
                self.updater = updater;

                if (self.QueryString['supervisor'] != null) {
                    self.SelectedSupervisor({ UserName: self.QueryString['supervisor'] });
                }

                self.Archived(self.QueryString['archived']);
                self.InterviewerOptionFilter(self.QueryString['InterviewerOptionFilter']);

                self.Url.query['supervisor'] = self.QueryString['supervisor'] || "";
                self.Url.query['archived'] = self.QueryString['archived'] || "";
                self.Url.query['InterviewerOptionFilter'] = self.QueryString['InterviewerOptionFilter'] || "";

                self.SelectedSupervisor.subscribe(updater);
                self.Archived.subscribe(updater);
                self.InterviewerOptionFilter.subscribe(updater);
            };

            self.IsNothingSelected = ko.computed(function() {
                return $(self.SelectedItems()).length === 0;
            });
        };

        Supervisor.Framework.Classes.inherit(Supervisor.VM.InterviewersNew, Supervisor.VM.BasePage);

        var InterviewersListModel = function(ajax, notifier) {

            var allInterviewersApiUrl = '@Url.RouteUrl("DefaultApiWithAction", new {httproute = "", controller = "UsersApi", action = "AllInterviewers"})';
            var editUrl = '@Url.Action("Profile", "Interviewer", new {area = string.Empty})';
            var $interviewersPageUrl = '@Html.Raw(@Url.Action("Index", "Interviewers", new {}, Request.Url.Scheme))';
            var $interviewersApiUrl = '@Url.RouteUrl("DefaultApiWithAction", new {httproute = "", controller = "UsersApi", action = "AllInterviewers"})';
            var $supervisorsUrl = '@Url.RouteUrl("DefaultApiWithAction", new {httproute = "", controller = "Teams", action = "Supervisors"})';
            var $commandExecutionUrl = '@Url.RouteUrl("DefaultApiWithAction", new {httproute = "", controller = "CommandApi", action = "ExecuteCommands"})';
            var $archiveUsersUrl = '@Url.RouteUrl("DefaultApiWithAction", new {httproute = "", controller = "UsersApi", action = "ArchiveUsers"})';

            var model = new Supervisor.VM.InterviewersNew(
                $interviewersApiUrl,
                $archiveUsersUrl,
                $interviewersPageUrl,
                $supervisorsUrl,
                ajax,
                notifier);
            ko.applyBindings(model);

            var requestHeaders = {};
            requestHeaders[input.settings.acsrf.tokenName] = input.settings.acsrf.token;

            var onTableInitComplete = function() {
                $('.dataTables_filter label')
                    .on('click',
                        function(e) {
                            if (e.target !== this)
                                return;
                            $(this).toggleClass("active");
                            $(this).children("input[type='search']").delay(200).queue(function () { $(this).focus(); $(this).dequeue(); });

                            $(".column-questionnaire-title").toggleClass("padding-left-slide");
                        });
            };

            $.fn.dataTable.ext.errMode = 'none';

            var table = $('table#interviewers')
                .on('init.dt', onTableInitComplete)
                .on('xhr.dt', function (e, settings, json, xhr) {
                    if (xhr.status === 401)
                        location.reload();
                    else if (xhr.status != undefined && xhr.status !== 200)
                        notifier.showError("@Pages.OperationFailedTitle", "@Pages.OperationFailedDescription");
                })
                .DataTable({
                    processing: true,
                    language:
                    {
                        "url": window.input.settings.config.dataTableTranslationsUrl,
                        searchPlaceholder: "@Pages.Search"
                    },
                    serverSide: true,
                    ajax: {
                        url: allInterviewersApiUrl,
                        type: "POST",
                        headers: requestHeaders,
                        "data": function(d) {
                            model.SelectedItems.removeAll(); // move to before filter event

                            d.SupervisorName = _.isUndefined(model.SelectedSupervisor())
                                ? null
                                : model.SelectedSupervisor().UserName;
                            d.Archived = model.Archived();
                            d.InterviewerOptionFilter = model.InterviewerOptionFilter();
                        }
                    },
                    columns: [
                        @if (isAdmin)
                        {
                            <text>
                            {
                                "orderable": false,
                                render: function(data, type, row) {
                                    return "<input class=\"checkbox-filter\" id=\"cbx_" +
                                        row.userId +
                                        "\" value=\"" +
                                        row.userId +
                                        "\" type=\"checkbox\"> <label for=\"cbx_" +
                                        row.userId +
                                        "\"><span class=\"tick\"></span></label> ";
                                },
                                "class": "checkbox-cell"
                            },
                            </text>
                        }
                        {
                            data: "userName",
                            name: "UserName", // case-sensitive!
                            render: function (data, type, row) {
                                if(!row.isArchived)
                                    return "<a href=" + editUrl + "/" + row.userId + ">" + data + "</a>";
                                else
                                    return data;
                            }
                        },
                        {
                            data: "creationDate",
                            name: "CreationDate", // case-sensitive!
                            "class": "changed-recently"
                        },
                        {
                            data: "email",
                            name: "Email", // case-sensitive!
                            render: function(data, type, row) {
                                return data ? "<a href='mailto:" + data + "'>" + data + "</a>" : "";
                            },
                            "class": "changed-recently"
                        },
                        @if (isVisibleSupervisorColumn)
                        {
                            <text>
                            {
                                "orderable":
                                false,
                                data:
                                "supervisorName",
                                name:
                                "SupervisorName", // case-sensitive!
                                "class":
                                "changed-recently"
                            }
                        ,</text>
                        }
                        {
                            orderable: true,
                            data: "enumeratorVersion",
                            name: "EnumeratorVersion", // case-sensitive!
                            createdCell: function (td, cellData, rowData, row, col) {
                                if (cellData) {
                                    $(td).css('color', rowData.isUpToDate ? 'green' : 'red');
                                }
                            },
                            "defaultContent": "@HttpUtility.JavaScriptStringEncode(Pages.Interviewers_InterviewerNeverConnected)",
                            "class": "changed-recently"
                        }
                    ],
                    searchHighlight: true,
                    rowId: 'userId',
                    pagingType: "full_numbers",
                    lengthChange: false, // do not show page size selector
                    pageLength: 50, // page size
                    "order": [[1, 'asc']],
                    conditionalPaging: true
                });

            var updater = function() {

                table.ajax.reload();
            }

            model.load(updater);

            // Handle click on "Select all" control
            $('#check-all')
                .on('click',
                    function() {
                        // Get all rows with search applied
                        var rows = table.rows({ 'search': 'applied' }).nodes();
                        // Check/uncheck checkboxes for all rows in the table

                        var checkboxes = $('input[type="checkbox"]', rows);

                        var newState = this.checked;

                        _.forEach(checkboxes,
                            function(checkbox) {
                                if (newState) {
                                    if (!checkbox.checked) {
                                        model.SelectedItems.push(checkbox.value);
                                    }
                                } else {
                                    if (checkbox.checked) {
                                        var indexOfInterviewer = model.SelectedItems.indexOf(checkbox.value);
                                        model.SelectedItems.splice(indexOfInterviewer, 1);
                                    }
                                }
                         });

                        checkboxes.prop('checked', newState);

                    });

            // Handle click on checkbox to set state of "Select all" control
            $('#interviewers tbody')
                .on('change',
                    'input[type="checkbox"]',
                    function() {
                        // If checkbox is not checked
                        if (!this.checked) {
                            var indexOfInterviewer = model.SelectedItems.indexOf(this.value);
                            model.SelectedItems.splice(indexOfInterviewer, 1);

                            var el = $('#check-all').get(0);
                            // If "Select all" control is checked and has 'indeterminate' property
                            if (el && el.checked && ('indeterminate' in el)) {
                                // Set visual state of "Select all" control
                                // as 'indeterminate'
                                el.indeterminate = true;
                            }
                        } else {
                            model.SelectedItems.push(this.value);
                        }
                    });

        };

        $(function() {
            var notifier = new Notifier();
            var interviewersModel = new InterviewersListModel(new Ajax(notifier), notifier);
        });

    </script>
}

<main class="hold-transition">
    <div class="container-fluid">
        <div class="row">
            <aside class="filters">
                <div class="foldback-button" id="hide-filters">
                    <span class="arrow"></span>
                    <span class="arrow"></span>
                    <span class="glyphicon glyphicon-tasks" aria-hidden="true"></span>
                </div>

                <div class="filters-container">
                    <h4>@Pages.FilterTitle:</h4> 
                    @if (isVisibleSupervisorColumn)
                    {
                        <div class="block-filter">
                            <h5 >@Pages.Interviewers_SupervisorTitle</h5>
                            <div class="input-group">
                                <input class="form-control" placeholder="@Pages.AnyOption" data-bind="typeahead: SelectedSupervisor, typeaheadOptions: {source: Supervisors, displayText: function(item){return item.UserName}}, valueupdate:'afterkeydown'" type="text" />
                                <span data-bind="spinner: IsSupervisorsLoading, spinnerOptions: { 'left': 1, 'right': '50px' }"></span>
                                <div class="input-group-btn" data-bind="click: function(){ SelectedSupervisor(undefined); }">
                                    <div class="btn btn-default"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></div>
                                </div>
                            </div>
                        </div>
                    }
                    <div class="block-filter">
                        <h5>@Pages.Interviewers_InterviewerVersion</h5>
                        <select data-bind="value: InterviewerOptionFilter" class="selectpicker">
                            <option value="@InterviewerOptionFilter.Any.ToString()">@Pages.AnyOption</option>
                            <option value="@InterviewerOptionFilter.NotSynced.ToString()">@Pages.Interviewers_NotSyncedOption</option>
                            <option value="@InterviewerOptionFilter.UpToDate.ToString()">@Pages.Interviewers_UpToDateOption</option>
                            <option value="@InterviewerOptionFilter.Outdated.ToString()">@Pages.Interviewers_OutdatedOption</option>
                        </select>
                    </div>

                    <div class="block-filter">
                        <h5 >@Pages.Interviewers_ArchiveStatusTitle</h5>
                        <select data-bind="value: Archived" class="selectpicker">
                            <option value="false">@Pages.Interviewers_ActiveUsers</option>
                            <option value="true">@Pages.Interviewers_ArchivedUsers</option>
                        </select>
                    </div>
                </div>
            </aside>
            
            <div class="main-information">
                @Html.Partial("_alerts")
                <div class="page-header clearfix">
                    <div>
                        <h1>@Pages.Interviewers_Header</h1>
                        @if (isVisibleSupervisorColumn)
                        {
                            <a class="btn btn-success" href="@Url.Action("Create", "Interviewer", new {area = string.Empty})">
                                @Users.AddInterviewer
                            </a>
                        }
                    </div>
                </div>
                <table id="interviewers" class="table table-striped table-ordered table-bordered table-hover table-with-checkboxes">
                    <thead>
                    <tr>
                        @if (isAdmin)
                        {
                            <th class="sorting_disabled checkbox-cell">
                                <input class="double-checkbox" id="check-all" type="checkbox">
                                <label for="check-all">
                                    <span class="tick"></span>
                                </label>
                            </th>
                        }
                        <th>@Pages.Interviewers_UserNameTitle</th>
                        <th class="for-tablets" title="@Pages.Interviewers_CreationDateTooltip">@Pages.Interviewers_CreationDateTitle</th>
                        <th class="for-mobile-devices">@Pages.Interviewers_EmailTitle</th>
                        @if (isVisibleSupervisorColumn)
                        {
                            <th title="@Pages.Interviewers_SupervisorTooltip">@Pages.Interviewers_SupervisorTitle</th>
                        }
                        <th title="@Pages.Interviewers_InterviewerVersionTooltip">@Pages.Interviewers_InterviewerVersion</th>
                    </tr>
                    </thead>
                </table>

                @if (isAdmin)
                {
                    <div class="panel panel-table" data-bind="visible: SelectedItems().length > 0">
                        <div class="panel-body">
                            <input class="double-checkbox-white" id="q1az" type="checkbox" checked disabled="disabled">
                            <label for="q1az">
                                <span class="tick"></span>  <span data-bind="text: SelectedItems().length + ' @Pages.Interviewers_Selected'"></span> 
                            </label>
                            <button type="button" class="btn btn-default btn-danger" data-bind="visible: Archived() != 'true', disable: IsNothingSelected, click: $root.archiveInterviewers">@Pages.Interviewers_Archive</button>
                            <button type="button" class="btn btn-default btn-danger" data-bind="visible: Archived() == 'true', disable: IsNothingSelected, click: $root.unarchiveInterviewers">@Pages.Interviewers_Unarchive</button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</main>