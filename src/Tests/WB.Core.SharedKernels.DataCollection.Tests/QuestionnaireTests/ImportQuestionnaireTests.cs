using System;
using Main.Core.Documents;
using Main.Core.Events.Questionnaire;
using Microsoft.Practices.ServiceLocation;
using Moq;
using Ncqrs.Spec;
using NUnit.Framework;
using Newtonsoft.Json;
using WB.Core.SharedKernels.DataCollection.Exceptions;
using WB.Core.SharedKernels.DataCollection.Implementation.Aggregates;

namespace WB.Core.SharedKernels.DataCollection.Tests.QuestionnaireTests
{
    internal class ImportQuestionnaireTests : QuestionnaireTestsContext
    {
        [SetUp]
        public void SetUp()
        {
            ServiceLocator.SetLocatorProvider(() => new Mock<IServiceLocator> { DefaultValue = DefaultValue.Mock }.Object);
        }

        [Test]
        public void CreateNewSnapshot_When_ArgumentIsNotNull_Then_TemplateImportedEventIsRised()
        {
            using (var eventContext = new EventContext())
            {
                // arrange
                Questionnaire questionnaire = CreateQuestionnaire();
                var newState = new QuestionnaireDocument();

                // act
                questionnaire.ImportQuestionnaire(Guid.NewGuid(),newState);

                // assert
                Assert.That(GetLastEvent<TemplateImported>(eventContext).Source, Is.EqualTo(newState));
            }
        }


        [Test]
        public void Execute_When_SourceIsNotQuestionnaireDocument_Then_QuestionnaireException_should_be_thrown()
        {
            using (var eventContext = new EventContext())
            {
                // arrange
                Questionnaire questionnaire = CreateQuestionnaire();
                Mock<IQuestionnaireDocument> docMock = new Mock<IQuestionnaireDocument>();
                // act
                TestDelegate act =
                    () =>
                    questionnaire.ImportQuestionnaire(Guid.NewGuid(), docMock.Object);
                // assert
                Assert.Throws<QuestionnaireException>(act);
            }
        }
        
        [Test]
        [TestCase("{ \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.DateTimeQuestion, Main.Core\", \"AddDateTimeAttr\": null, \"DateTimeAttr\": \"0001-01-01T00:00:00.0000000\", \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"356fd964-e5bf-4082-aee5-53a2b383ee69\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"Today's date\", \"QuestionType\": \"DateTime\", \"StataExportCaption\": \"date\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Question.TextQuestion, Main.Core\", \"AddTextAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"7f88f9da-51e5-4d2d-be11-69b0864b4d3d\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What was the weather on %date% ?\", \"QuestionType\": \"Text\", \"StataExportCaption\": \"weather\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"None\", \"PublicKey\": \"5921878e-be22-471d-9cf3-7831e9a9b4a6\", \"Title\": \"Main\", \"Triggers\": [] }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.AutoPropagateQuestion, Main.Core\", \"AddNumericAttr\": null, \"IntAttr\": 0, \"Triggers\": [ \"497549ff-38f4-4bed-bb61-8ae5358483bc\", \"7a04f498-166f-4278-9628-d809b350627e\" ], \"MaxValue\": 10, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"7117d8e3-1d97-464f-a900-898bc9f97fa9\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"How many people for date of %date%\", \"QuestionType\": \"AutoPropagate\", \"StataExportCaption\": \"people_count\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.TextQuestion, Main.Core\", \"AddTextAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"539d6830-87e5-4453-88cb-fd53ee0c6151\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What is your name?\", \"QuestionType\": \"Text\", \"StataExportCaption\": \"name\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Question.NumericQuestion, Main.Core\", \"IsInteger\": true, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"84c8aac6-7442-4155-b6cb-0950ddfcaa4e\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What is age of %name%\", \"QuestionType\": \"Numeric\", \"StataExportCaption\": \"age\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"AutoPropagated\", \"PublicKey\": \"497549ff-38f4-4bed-bb61-8ae5358483bc\", \"Title\": \"people\", \"Triggers\": [] }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.SingleQuestion, Main.Core\", \"AddSingleAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"Awesome\", \"AnswerType\": \"Select\", \"AnswerValue\": \"1\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"574320a6-79b3-449e-bef1-d48702cd2143\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"OK\", \"AnswerType\": \"Select\", \"AnswerValue\": \"2\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"e46479c0-93ff-4a3f-89ec-049deb2aa1f7\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"So-so\", \"AnswerType\": \"Select\", \"AnswerValue\": \"3\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"268c009a-b5db-476f-844e-dab8bc953daf\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"Bad\", \"AnswerType\": \"Select\", \"AnswerValue\": \"4\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"ebbdbec8-9efa-431b-83ac-c13a58949c27\" } ], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"adb871d4-417a-469c-913d-d93c0a5dac7d\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"at the age of %age% %name% think about him self\", \"QuestionType\": \"SingleOption\", \"StataExportCaption\": \"mind\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"AutoPropagated\", \"PublicKey\": \"7a04f498-166f-4278-9628-d809b350627e\", \"Title\": \"2nd roster\", \"Triggers\": [] } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"None\", \"PublicKey\": \"e85ebddd-b6ea-4505-99ff-763fc97755b7\", \"Title\": \"With Roster\", \"Triggers\": [] } ], \"CloseDate\": null, \"ConditionExpression\": \"\", \"CreationDate\": \"2013-10-16T18:30:34.7118893Z\", \"LastEntryDate\": \"2013-10-16T18:38:44.9133838Z\", \"OpenDate\": null, \"IsDeleted\": false, \"CreatedBy\": null, \"IsPublic\": false, \"Propagated\": \"None\", \"PublicKey\": \"743fede4-ce2f-4618-967e-679ef905ffbd\", \"Title\": \"question with substitution\", \"Description\": null, \"Triggers\": [], \"SharedPersons\": [], \"LastEventSequence\": 13 }")]
        public void ImportQuestionnaire_If_Valid_Questionnaire_Imported_Correct_Event_is_Published_Then_TemplateImportedEventIsRised(string questionnaireTemplate)
        {
            using (var eventContext = new EventContext())
            {
                // arrange
                Questionnaire questionnaire = CreateQuestionnaire();
                var newState = JsonConvert.DeserializeObject<QuestionnaireDocument>(questionnaireTemplate, new JsonSerializerSettings { TypeNameHandling = TypeNameHandling.Objects });

                // act
                questionnaire.ImportQuestionnaire(Guid.NewGuid(), newState);

                // assert
                Assert.That(GetLastEvent<TemplateImported>(eventContext).Source, Is.EqualTo(newState));
            }
        }

        [Test]
        [TestCase("{ \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.DateTimeQuestion, Main.Core\", \"AddDateTimeAttr\": null, \"DateTimeAttr\": \"0001-01-01T00:00:00.0000000\", \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"356fd964-e5bf-4082-aee5-53a2b383ee69\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"Today's date\", \"QuestionType\": \"DateTime\", \"StataExportCaption\": \"date\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Question.TextQuestion, Main.Core\", \"AddTextAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"7f88f9da-51e5-4d2d-be11-69b0864b4d3d\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What was the weather on %date% ?\", \"QuestionType\": \"Text\", \"StataExportCaption\": \"weather\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"None\", \"PublicKey\": \"5921878e-be22-471d-9cf3-7831e9a9b4a6\", \"Title\": \"Main\", \"Triggers\": [] }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.AutoPropagateQuestion, Main.Core\", \"AddNumericAttr\": null, \"IntAttr\": 0, \"Triggers\": [ \"497549ff-38f4-4bed-bb61-8ae5358483bc\", \"7a04f498-166f-4278-9628-d809b350627e\" ], \"MaxValue\": 10, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"7117d8e3-1d97-464f-a900-898bc9f97fa9\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"How many people for date of %date%\", \"QuestionType\": \"AutoPropagate\", \"StataExportCaption\": \"people_count\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.TextQuestion, Main.Core\", \"AddTextAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"539d6830-87e5-4453-88cb-fd53ee0c6151\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What is your name?\", \"QuestionType\": \"Text\", \"StataExportCaption\": \"name\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Question.NumericQuestion, Main.Core\", \"IsInteger\": true, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"84c8aac6-7442-4155-b6cb-0950ddfcaa4e\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What is age of %name%\", \"QuestionType\": \"Numeric\", \"StataExportCaption\": \"age\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"AutoPropagated\", \"PublicKey\": \"497549ff-38f4-4bed-bb61-8ae5358483bc\", \"Title\": \"people\", \"Triggers\": [] }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.MultyOptionsQuestion, Main.Core\", \"AddSingleAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"Awesome\", \"AnswerType\": \"Select\", \"AnswerValue\": \"1\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"574320a6-79b3-449e-bef1-d48702cd2143\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"OK\", \"AnswerType\": \"Select\", \"AnswerValue\": \"2\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"e46479c0-93ff-4a3f-89ec-049deb2aa1f7\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"So-so\", \"AnswerType\": \"Select\", \"AnswerValue\": \"3\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"268c009a-b5db-476f-844e-dab8bc953daf\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"Bad\", \"AnswerType\": \"Select\", \"AnswerValue\": \"4\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"ebbdbec8-9efa-431b-83ac-c13a58949c27\" } ], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"adb871d4-417a-469c-913d-d93c0a5dac7d\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"at the age of %age% %name% think about him self\", \"QuestionType\": \"MultyOption\", \"StataExportCaption\": \"mind\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null, \"MaxAllowedAnswers\" : \"3\" } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"AutoPropagated\", \"PublicKey\": \"7a04f498-166f-4278-9628-d809b350627e\", \"Title\": \"2nd roster\", \"Triggers\": [] } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"None\", \"PublicKey\": \"e85ebddd-b6ea-4505-99ff-763fc97755b7\", \"Title\": \"With Roster\", \"Triggers\": [] } ], \"CloseDate\": null, \"ConditionExpression\": \"\", \"CreationDate\": \"2013-10-16T18:30:34.7118893Z\", \"LastEntryDate\": \"2013-10-16T18:38:44.9133838Z\", \"OpenDate\": null, \"IsDeleted\": false, \"CreatedBy\": null, \"IsPublic\": false, \"Propagated\": \"None\", \"PublicKey\": \"743fede4-ce2f-4618-967e-679ef905ffbd\", \"Title\": \"question with substitution\", \"Description\": null, \"Triggers\": [], \"SharedPersons\": [], \"LastEventSequence\": 13 }")]
        public void ImportQuestionnaire_If_MultiQuestions_Have_Valid_MaxAllowedAnswers_Then_TemplateImportedEventIsRised(string questionnaireTemplate)
        {
            using (var eventContext = new EventContext())
            {
                // arrange
                Questionnaire questionnaire = CreateQuestionnaire();
                var newState = JsonConvert.DeserializeObject<QuestionnaireDocument>(questionnaireTemplate, new JsonSerializerSettings { TypeNameHandling = TypeNameHandling.Objects });

                // act
                questionnaire.ImportQuestionnaire(Guid.NewGuid(), newState);

                // assert
                Assert.That(GetLastEvent<TemplateImported>(eventContext).Source, Is.EqualTo(newState));
            }
        }

        [Test]
        [TestCase(
            "{ \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.DateTimeQuestion, Main.Core\", \"AddDateTimeAttr\": null, \"DateTimeAttr\": \"0001-01-01T00:00:00.0000000\", \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"356fd964-e5bf-4082-aee5-53a2b383ee69\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"Today's date\", \"QuestionType\": \"DateTime\", \"StataExportCaption\": \"date\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Question.TextQuestion, Main.Core\", \"AddTextAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"7f88f9da-51e5-4d2d-be11-69b0864b4d3d\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What was the weather on %date% ?\", \"QuestionType\": \"Text\", \"StataExportCaption\": \"weather\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"None\", \"PublicKey\": \"5921878e-be22-471d-9cf3-7831e9a9b4a6\", \"Title\": \"Main\", \"Triggers\": [] }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.AutoPropagateQuestion, Main.Core\", \"AddNumericAttr\": null, \"IntAttr\": 0, \"Triggers\": [ \"497549ff-38f4-4bed-bb61-8ae5358483bc\", \"7a04f498-166f-4278-9628-d809b350627e\" ], \"MaxValue\": 10, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"7117d8e3-1d97-464f-a900-898bc9f97fa9\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"How many people for date of %date%\", \"QuestionType\": \"AutoPropagate\", \"StataExportCaption\": \"people_count\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.TextQuestion, Main.Core\", \"AddTextAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"539d6830-87e5-4453-88cb-fd53ee0c6151\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What is your name?\", \"QuestionType\": \"Text\", \"StataExportCaption\": \"name\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Question.NumericQuestion, Main.Core\", \"IsInteger\": true, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"84c8aac6-7442-4155-b6cb-0950ddfcaa4e\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What is age of %name%\", \"QuestionType\": \"Numeric\", \"StataExportCaption\": \"age\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"AutoPropagated\", \"PublicKey\": \"497549ff-38f4-4bed-bb61-8ae5358483bc\", \"Title\": \"people\", \"Triggers\": [] }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.MultyOptionsQuestion, Main.Core\", \"AddSingleAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"Awesome\", \"AnswerType\": \"Select\", \"AnswerValue\": \"1\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"574320a6-79b3-449e-bef1-d48702cd2143\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"OK\", \"AnswerType\": \"Select\", \"AnswerValue\": \"2\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"e46479c0-93ff-4a3f-89ec-049deb2aa1f7\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"So-so\", \"AnswerType\": \"Select\", \"AnswerValue\": \"3\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"268c009a-b5db-476f-844e-dab8bc953daf\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"Bad\", \"AnswerType\": \"Select\", \"AnswerValue\": \"4\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"ebbdbec8-9efa-431b-83ac-c13a58949c27\" } ], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"adb871d4-417a-469c-913d-d93c0a5dac7d\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"at the age of %age% %name% think about him self\", \"QuestionType\": \"MultyOption\", \"StataExportCaption\": \"mind\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null, \"MaxAllowedAnswers\" : -1 } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"AutoPropagated\", \"PublicKey\": \"7a04f498-166f-4278-9628-d809b350627e\", \"Title\": \"2nd roster\", \"Triggers\": [] } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"None\", \"PublicKey\": \"e85ebddd-b6ea-4505-99ff-763fc97755b7\", \"Title\": \"With Roster\", \"Triggers\": [] } ], \"CloseDate\": null, \"ConditionExpression\": \"\", \"CreationDate\": \"2013-10-16T18:30:34.7118893Z\", \"LastEntryDate\": \"2013-10-16T18:38:44.9133838Z\", \"OpenDate\": null, \"IsDeleted\": false, \"CreatedBy\": null, \"IsPublic\": false, \"Propagated\": \"None\", \"PublicKey\": \"743fede4-ce2f-4618-967e-679ef905ffbd\", \"Title\": \"question with substitution\", \"Description\": null, \"Triggers\": [], \"SharedPersons\": [], \"LastEventSequence\": 13 }"
            )]
        public void ImportQuestionnaire_If_MultiQuestions_Have_InValid_MaxAllowedAnswers_Then_ThrowQuestionnaireException(
            string questionnaireTemplate)
        {
            // arrange
            Questionnaire questionnaire = CreateQuestionnaire();
            var newState = JsonConvert.DeserializeObject<QuestionnaireDocument>(questionnaireTemplate,
                new JsonSerializerSettings { TypeNameHandling = TypeNameHandling.Objects });

            // act
            TestDelegate act =
                () =>
                    questionnaire.ImportQuestionnaire(Guid.NewGuid(), newState);
            // assert
            Assert.Throws<QuestionnaireException>(act);
        }

        [Test]
        [TestCase(
            "{ \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.DateTimeQuestion, Main.Core\", \"AddDateTimeAttr\": null, \"DateTimeAttr\": \"0001-01-01T00:00:00.0000000\", \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"356fd964-e5bf-4082-aee5-53a2b383ee69\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"Today's date\", \"QuestionType\": \"DateTime\", \"StataExportCaption\": \"date\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Question.TextQuestion, Main.Core\", \"AddTextAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"7f88f9da-51e5-4d2d-be11-69b0864b4d3d\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What was the weather on %date% ?\", \"QuestionType\": \"Text\", \"StataExportCaption\": \"weather\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"None\", \"PublicKey\": \"5921878e-be22-471d-9cf3-7831e9a9b4a6\", \"Title\": \"Main\", \"Triggers\": [] }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.AutoPropagateQuestion, Main.Core\", \"AddNumericAttr\": null, \"IntAttr\": 0, \"Triggers\": [ \"497549ff-38f4-4bed-bb61-8ae5358483bc\", \"7a04f498-166f-4278-9628-d809b350627e\" ], \"MaxValue\": 10, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"7117d8e3-1d97-464f-a900-898bc9f97fa9\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"How many people for date of %date%\", \"QuestionType\": \"AutoPropagate\", \"StataExportCaption\": \"people_count\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.TextQuestion, Main.Core\", \"AddTextAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"539d6830-87e5-4453-88cb-fd53ee0c6151\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What is your name?\", \"QuestionType\": \"Text\", \"StataExportCaption\": \"name\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null }, { \"$type\": \"Main.Core.Entities.SubEntities.Question.NumericQuestion, Main.Core\", \"IsInteger\": true, \"AnswerOrder\": \"AsIs\", \"Answers\": [], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"84c8aac6-7442-4155-b6cb-0950ddfcaa4e\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"What is age of %name%\", \"QuestionType\": \"Numeric\", \"StataExportCaption\": \"age\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"AutoPropagated\", \"PublicKey\": \"497549ff-38f4-4bed-bb61-8ae5358483bc\", \"Title\": \"people\", \"Triggers\": [] }, { \"$type\": \"Main.Core.Entities.SubEntities.Group, Main.Core\", \"Children\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Question.MultyOptionsQuestion, Main.Core\", \"AddSingleAttr\": null, \"AnswerOrder\": \"AsIs\", \"Answers\": [ { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"Awesome\", \"AnswerType\": \"Select\", \"AnswerValue\": \"1\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"574320a6-79b3-449e-bef1-d48702cd2143\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"OK\", \"AnswerType\": \"Select\", \"AnswerValue\": \"2\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"e46479c0-93ff-4a3f-89ec-049deb2aa1f7\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"So-so\", \"AnswerType\": \"Select\", \"AnswerValue\": \"3\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"268c009a-b5db-476f-844e-dab8bc953daf\" }, { \"$type\": \"Main.Core.Entities.SubEntities.Answer, Main.Core\", \"AnswerImage\": null, \"AnswerText\": \"Bad\", \"AnswerType\": \"Select\", \"AnswerValue\": \"4\", \"Mandatory\": false, \"NameCollection\": null, \"PublicKey\": \"ebbdbec8-9efa-431b-83ac-c13a58949c27\" } ], \"Capital\": false, \"Cards\": [], \"Children\": [], \"Comments\": null, \"ConditionExpression\": \"\", \"ConditionalDependentGroups\": [], \"ConditionalDependentQuestions\": [], \"Featured\": false, \"Instructions\": \"\", \"Mandatory\": false, \"PublicKey\": \"adb871d4-417a-469c-913d-d93c0a5dac7d\", \"QuestionScope\": \"Interviewer\", \"QuestionText\": \"at the age of %age% %name% think about him self\", \"QuestionType\": \"MultyOption\", \"StataExportCaption\": \"mind\", \"ValidationExpression\": \"\", \"ValidationMessage\": \"\", \"LinkedToQuestionId\": null, \"MaxAllowedAnswers\" : 5 } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"AutoPropagated\", \"PublicKey\": \"7a04f498-166f-4278-9628-d809b350627e\", \"Title\": \"2nd roster\", \"Triggers\": [] } ], \"ConditionExpression\": \"\", \"Enabled\": true, \"Description\": \"\", \"Propagated\": \"None\", \"PublicKey\": \"e85ebddd-b6ea-4505-99ff-763fc97755b7\", \"Title\": \"With Roster\", \"Triggers\": [] } ], \"CloseDate\": null, \"ConditionExpression\": \"\", \"CreationDate\": \"2013-10-16T18:30:34.7118893Z\", \"LastEntryDate\": \"2013-10-16T18:38:44.9133838Z\", \"OpenDate\": null, \"IsDeleted\": false, \"CreatedBy\": null, \"IsPublic\": false, \"Propagated\": \"None\", \"PublicKey\": \"743fede4-ce2f-4618-967e-679ef905ffbd\", \"Title\": \"question with substitution\", \"Description\": null, \"Triggers\": [], \"SharedPersons\": [], \"LastEventSequence\": 13 }"
            )]
        public void ImportQuestionnaire_If_MultiQuestions_Have_Number_Of_Options_More_Than_MaxAllowedAnswers_Then_ThrowQuestionnaireException(
            string questionnaireTemplate)
        {
            // arrange
            Questionnaire questionnaire = CreateQuestionnaire();
            var newState = JsonConvert.DeserializeObject<QuestionnaireDocument>(questionnaireTemplate,
                new JsonSerializerSettings { TypeNameHandling = TypeNameHandling.Objects });

            // act
            TestDelegate act =
                () =>
                    questionnaire.ImportQuestionnaire(Guid.NewGuid(), newState);
            // assert
            Assert.Throws<QuestionnaireException>(act);
        }
    }
}
