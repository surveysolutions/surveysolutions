<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:bal="http://schemas.microsoft.com/wix/BalExtension">

    <Bundle Name="SurveySolutions"
            Version="$(var.SurveySolutionsVersion)"
            Manufacturer="The World Bank"
            UpgradeCode="D101A3BD-9921-4BBC-8F13-2B496A721317" >

        <!--allow only install to Server OS x64 starting Server 2012 R2 x64 but not on old laptop with consumer OS-->
        <bal:Condition Message="This application requires Windows Server 2012 R2 x64 or newer.">
            (VersionNT64 &gt;= v6.3) 
        </bal:Condition>
        
        <util:ProductSearch 
            Id="OldProductSearch" 
            UpgradeCode="0C543B8A-9023-4486-89C9-421D875F5AFA" 
            Variable="OldProductInstalled" 
            Result="state"/>

        <bal:Condition Message="Please uninstall previous version of Survey Solutions.">
            (OldProductInstalled = 2)
        </bal:Condition>

        <BootstrapperApplicationRef Id="WixStandardBootstrapperApplication.HyperlinkLicense" >
            <bal:WixStandardBootstrapperApplication 
                LicenseUrl=""
                LogoFile="img\logo-50.bmp"
                LogoSideFile="img\logo-50.bmp"
                ShowVersion="yes"
                SuppressOptionsUI="yes"/>
            
        <!--SuppressRepair="yes"-->
        
        </BootstrapperApplicationRef>

        <!-- Visual C++ 2015 Redistributable (x64) minimum runtime msi package version -->
        <util:ProductSearch
            Id="VCRedist2015x64"
            Result="version"
            Variable="VCRedist2015x64"
            UpgradeCode="36F68A90-239C-34DF-B58C-64B30153CE35"
            Condition="VersionNT64" />

        <!-- Visual C++ 2015 Redistributable (x86) minimum runtime msi package version -->
        <util:ProductSearch
            Id="VCRedist2015x86"
            Result="version"
            Variable="VCRedist2015x86"
            UpgradeCode="65E5BD06-6392-3027-8C26-853107D3CF1A"
            Condition="VersionNT" />

        <!-- Visual C++ 2015 Redistributable version -->
        <Variable Name="VCRedist2015" Type="version" Value="14.0.24215" />

        <Chain>
            <PackageGroupRef Id="NetFx471WebLocal" />

            <!-- Visual C++ 2015 Redistributable Update 3 (x64) -->
            <ExePackage
              Id="vc_redist.x64.exe"
              Name="vc_redist.x64.14.0.24215.1.exe"
              DisplayName="Microsoft Visual C++ 2015 Redistributable (x64) - 14.0.24215"
              Cache="no"
              Compressed="no"
              PerMachine="yes"
              Permanent="yes"
              InstallCondition="VersionNT64"
              DetectCondition="VCRedist2015x64 >= VCRedist2015"
              DownloadUrl="https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x64.exe"
              InstallCommand="/install /quiet /norestart"
              RepairCommand="/repair /quiet /norestart"
              UninstallCommand="/uninstall /quiet /norestart" >
                <RemotePayload
                  ProductName="Visual C++ 2015 Redistributable Update 3 (x64)"
                  Version="14.0.24215.1"
                  Description="https://www.microsoft.com/en-us/download/details.aspx?id=53840"
                  CertificatePublicKey="371DD003A37769487A2A89A5A9DDB3026451B906"
                  CertificateThumbprint="98ED99A67886D020C564923B7DF25E9AC019DF26"
                  Hash="10B1683EA3FF5F36F225769244BF7E7813D54AD0"
                  Size="15301888" />
            </ExePackage>

            <!-- Visual C++ 2015 Redistributable Update 3 (x86) -->
            <ExePackage
              Id="vc_redist.x86.exe"
              Name="vc_redist.x86.14.0.24215.1.exe"
              DisplayName="Microsoft Visual C++ 2015 Redistributable (x86) - 14.0.24215"
              Cache="no"
              Compressed="no"
              PerMachine="yes"
              Permanent="yes"
              InstallCondition="VersionNT"
              DetectCondition="VCRedist2015x86 >= VCRedist2015"
              DownloadUrl="https://download.microsoft.com/download/6/A/A/6AA4EDFF-645B-48C5-81CC-ED5963AEAD48/vc_redist.x86.exe"
              InstallCommand="/install /quiet /norestart"
              RepairCommand="/repair /quiet /norestart"
              UninstallCommand="/uninstall /quiet /norestart" >
                <RemotePayload
                  ProductName="Visual C++ 2015 Redistributable Update 3 (x86)"
                  Version="14.0.24215.1"
                  Description="https://www.microsoft.com/en-us/download/details.aspx?id=53840"
                  CertificatePublicKey="371DD003A37769487A2A89A5A9DDB3026451B906"
                  CertificateThumbprint="98ED99A67886D020C564923B7DF25E9AC019DF26"
                  Hash="72211BD2E7DFC91EA7C8FAC549C49C0543BA791B"
                  Size="14456872" />
            </ExePackage>


            <RollbackBoundary />

            <MsiPackage Id="SurveySolutionsPackage"
              Cache="no"
              Compressed="yes"
              DisplayInternalUI="yes"
              Vital="yes"
              InstallCondition="VersionNT64"
              SourceFile="$(var.SurveySolutions.TargetPath)" >
            </MsiPackage>
        </Chain>
    </Bundle>
    
    <?define NetFx471MinRelease = 461308 ?>
    
    <Fragment>
        <PropertyRef Id="WIXNETFX4RELEASEINSTALLED" />
        <Property Id="WIX_IS_NETFRAMEWORK_471_OR_LATER_INSTALLED" Secure="yes" />
        <SetProperty Id="WIX_IS_NETFRAMEWORK_471_OR_LATER_INSTALLED" Value="1" After="AppSearch">
            WIXNETFX4RELEASEINSTALLED >= "#$(var.NetFx471MinRelease)"
        </SetProperty>
    </Fragment>

    <Fragment>
        <WixVariable Id="NetFx471WebDetectCondition" Value="NETFRAMEWORK45 &gt;= $(var.NetFx471MinRelease)" Overridable="yes" />
    
        <util:RegistrySearchRef Id="NETFRAMEWORK45"/>
    
        <PackageGroup Id="NetFx471WebLocal">
            <ExePackage Id="NetFx471WebLocal"
                    InstallCommand="/passive /showrmui /norestart /ChainingPackage &quot;[WixBundleName]&quot;"
                    PerMachine="yes"
                    Cache="no"
                    Compressed="yes"
                    Permanent="yes"
                    Vital="yes"
                    Name="NDP471-KB4033344-Web.exe"
                    SourceFile="redist\NDP471-KB4033344-Web.exe"
                    DetectCondition="!(wix.NetFx471WebDetectCondition)">
                <ExitCode Behavior="forceReboot" Value="1641" />
                <ExitCode Behavior="forceReboot" Value="3010" />
                <ExitCode Behavior="success" Value="0" />
            </ExePackage>
            <!--RepairCommand="/passive /showrmui /norestart /repair /ChainingPackage &quot;[WixBundleName]&quot;"
                    UninstallCommand="/uninstall /passive /showrmui /norestart /ChainingPackage &quot;[WixBundleName]&quot;"-->
        </PackageGroup>
    </Fragment>
</Wix>
