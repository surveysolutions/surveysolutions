<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" 
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension"
     xmlns:iis="http://schemas.microsoft.com/wix/IIsExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:localization="http://schemas.microsoft.com/wix/2006/localization">
    
    <Product Id="*" 
             Name="SurveySolutions" 
             Language="1033" 
             Version="$(var.SurveySolutionsVersion)" 
             Manufacturer="The World Bank" 
             UpgradeCode="0C543B8A-9023-4486-89C9-421D875F5AFA">

        <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Platform="x64"/>

        <!--not supported in wix 3.10 should be in 3.11 and 4-->
        <PropertyRef Id="WIX_IS_NETFRAMEWORK_462_OR_LATER_INSTALLED" />
        
        <Condition Message="This application requires .NET Framework 4.6.2 Please install the .NET 4.6.2 Framework then run this installer again.">
            <![CDATA[Installed OR WIX_IS_NETFRAMEWORK_462_OR_LATER_INSTALLED]]>
        </Condition>
            
        
        <Condition Message="This application only runs in Windows Server 2012 R2 or higher.">
            <![CDATA[Installed OR (VersionNT64 >= 603 AND MsiNTProductType > 1)]]>
        </Condition>

        <Property Id="SITEPORT" Value="9700"></Property>
        <Property Id="CONNSERVER" Value="127.0.0.1"></Property>
        <Property Id="CONNPORT" Value="5432"></Property>
        <Property Id="CONNUSERNAME" Value="postgres"></Property>
        
        <UI>

            <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
            <UIRef Id="WixUI_InstallDir" />

            <DialogRef Id="ConnectionStringDlg" />

            <!--Override original steps-->
            <!--Remove license agreement step-->
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg">NOT Installed</Publish>
            
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="5">1</Publish>

            
            <!--Redirect to new connection string step-->
            <Publish Dialog="InstallDirDlg" Control="Next" Event="NewDialog" Value="ConnectionStringDlg" Order="4">WIXUI_DONTVALIDATEPATH OR WIXUI_INSTALLDIR_VALID="1"</Publish>

            <!--Custom step-->
            <Publish Dialog="ConnectionStringDlg" Control="Back" Event="NewDialog" Value="InstallDirDlg">1</Publish>
            <Publish Dialog="ConnectionStringDlg" Control="Next" Event="NewDialog" Value="VerifyReadyDlg">1</Publish>

            <!--Override original step-->
            <Publish Dialog="VerifyReadyDlg" Control="Back" Event="NewDialog" Value="ConnectionStringDlg" Order="1">NOT Installed</Publish>

            <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="SurveySolutions has been succesfully installed." />

        </UI>
        
        <!--<WixVariable Id="WixUIInfoIco" Value="img/icon-32.bmp" />-->
        
        <UIRef Id="WixUI_InstallDir" />
        
        <Property Id="IISInstallCommandProperty" Value="/Online /Enable-Feature /All /FeatureName:IIS-WebServerRole /FeatureName:IIS-ASPNET45 /FeatureName:IIS-ManagementConsole /FeatureName:IIS-ISAPIFilter /FeatureName:IIS-NetFxExtensibility45 /FeatureName:NetFx4Extended-ASPNET45 /FeatureName:IIS-WebSockets /FeatureName:IIS-WindowsAuthentication /FeatureName:IIS-ManagementService /FeatureName:IIS-HttpCompressionDynamic"/>
                
        <!-- Use DISM to setup IIS (see also http://support.microsoft.com/kb/2736284) -->
        <!-- Build path to dism.exe (full path is important, just calling dism.exe without path will fail) -->
        <CustomAction Id="InstallIISSetProperty" 
                      Property="InstallIIS" 
                      Execute="immediate"
                      Value="&quot;[System64Folder]dism.exe&quot; [IISInstallCommandProperty]" />
        <!-- Call dism.exe quietly (without showing command prompt).
                 (see also http://wixtoolset.org/documentation/manual/v3/customactions/qtexec.html) -->
        <CustomAction Id="InstallIIS" 
                      BinaryKey="WixCA" 
                      DllEntry="CAQuietExec64"
                      Execute="deferred" 
                      HideTarget="no" 
                      Return="ignore" 
                      Impersonate="no"/>

        <InstallExecuteSequence>

            <Custom Action="InstallIISSetProperty" After="CostFinalize">
                <![CDATA[NOT Installed]]>
            </Custom>
            <Custom Action="InstallIIS" Before="WriteRegistryValues">
                <![CDATA[NOT Installed]]>
            </Custom>

        </InstallExecuteSequence>
        
        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        
        <MediaTemplate  EmbedCab="yes" />

        <Feature Id="ProductFeature" Title="SurveySolutions" Level="1">
        <ComponentGroupRef Id="ProductComponents" />
          
        <ComponentGroupRef Id="SettingsUpdate"  />
        </Feature>
    </Product>
    
    
            
    <Fragment>
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="INSTALLFOLDER" >
                    <Directory Id="INSTALLSITEFOLDER" Name="Site" ComponentGuidGenerationSeed="AA5F1DD2-13D8-442C-9978-8E8918EA789D" >
                        <Directory Id="CONFIGFOLDER" Name="Configuration">
                        </Directory>
                    </Directory>
            </Directory>
        </Directory>
        
        <SetDirectory Id='INSTALLFOLDER' Value='[WindowsVolume]SurveySolutions' />
    
    </Fragment>

    <Fragment>
        <ComponentGroup Id="ProductComponents" Directory="INSTALLSITEFOLDER">
           
                <Component Id="cmpAppPool" Guid="{CBA59BDC-989C-4F77-B0F9-861AAB8E0DEB}" KeyPath="yes" Win64="yes">
                    
                    <iis:WebAppPool
                        Id="SurveySolutionsSiteAppPool"
                        Name="SurveySolutionsSiteAppPool"
                        ManagedRuntimeVersion="v4.0"
                        ManagedPipelineMode="integrated"
                        Identity="applicationPoolIdentity" />

                    <iis:WebSite Id="webSite" SiteId="*" Description="SurveySolutionsSite" Directory="INSTALLSITEFOLDER" ConfigureIfExists="no">
                        <iis:WebAddress Id="webSite" Port="[SITEPORT]" />
                        <iis:WebDirProperties Id="webSite" AnonymousAccess="yes" WindowsAuthentication="no" />
                        <iis:WebApplication Id="webSite" WebAppPool="SurveySolutionsSiteAppPool" Name="SyrveySolutionsWebApplication" />

                        <iis:MimeMap Id="MIME_OTF" Extension=".otf" Type="application/x-font-otf" />
                        <iis:MimeMap Id="MIME_WOFF" Extension=".woff" Type="application/x-font-woff" />

                        <iis:MimeMap Id="MIME_APK" Extension=".apk" Type="application/vnd.android.package-archive" />
                    </iis:WebSite>

                </Component>
                
                <!--add harvested project output-->
            
                <ComponentGroupRef Id="ProductFilesComponentGroup"></ComponentGroupRef>
                
        </ComponentGroup>
        
        <ComponentGroup Id="SettingsUpdate" Directory="CONFIGFOLDER" >
                <Component Id="ConfigUpdate" Guid="035F0D52-04C7-4DB4-A9C7-C447F405C2EA" NeverOverwrite="yes">
                <CreateFolder/>
                <File Source="Headquarters.Web.config" PatchIgnore="yes" />

                <!--<connectionStrings>
                           <add name="Postgres" connectionString="Persist Security Info=true;Server=prod-db.mysurvey.solutions;Port=5432;User Id=brpdsa;Password=Qwerty1234;Database=brpdsa;ApplicationName=brpdsa" />
                </connectionStrings>-->
                <util:XmlFile Id="CreateElementConnectionStrings" 
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="createElement" 
                              ElementPath="//configuration"
                              Name="connectionStrings" Sequence='1'/>

                <util:XmlFile Id="CreateElementXml1" 
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="createElement" 
                              ElementPath="//configuration/connectionStrings"
                              Name="add" Sequence='2'/>
                
                <util:XmlFile Id="UpdateElementXml1"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/connectionStrings/add"
                              Name="name"
                              Value="Postgres"
                              Sequence='3'/>
                
               <util:XmlFile Id="UpdateConnectionStringProviderName"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/connectionStrings/add"
                              Name="providerName"
                              Value="Npgsql"
                              Sequence='4'/>

                <util:XmlFile Id="UpdateElementValueXml1"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/connectionStrings/add"
                              Name="connectionString"
                              Value="Server=[CONNSERVER];Port=[CONNPORT];User Id=[CONNUSERNAME];Password=[CONNPASSWORD];Database=SuperHQ;"
                              Sequence='5'/>
                
                <!--<add key="EventStore.Provider" value="Postgres" />-->
                <util:XmlFile Id="CreateElementXml2"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="createElement"
                              ElementPath="//configuration/appSettings"
                              Name="add" 
                              Sequence='6'/>

                <util:XmlFile Id="UpdateElementXml2"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/appSettings/add[\[]not(@key)[\]]"
                              Name="key"
                              Value="EventStore.Provider"
                              Sequence='7'/>

                <util:XmlFile Id="UpdateElementValueXml2"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/appSettings/add[\[]@key='EventStore.Provider'[\]]"
                              Name="value"
                              Value="Postgres"
                              Sequence='8'/>   
                    
                <!--<add key="DataStorePath" value="..." />-->
                <util:XmlFile Id="CreateElementXml3"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="createElement"
                              ElementPath="//configuration/appSettings"
                              Name="add" Sequence='9'/>

                <util:XmlFile Id="UpdateElementXml3"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/appSettings/add[\[]not(@key)[\]]"
                              Name="key"
                              Value="DataStorePath"
                              Sequence='10'/>

                <util:XmlFile Id="UpdateElementValueXml3"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/appSettings/add[\[]@key='DataStorePath'[\]]"
                              Name="value"
                              Value="[INSTALLFOLDER]Data_Site"
                              Sequence='11'/>
            
                <!--<add key="DesignerAddress" value="https://solutions.worldbank.org" />-->
                <util:XmlFile Id="CreateElementXml4"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="createElement"
                              ElementPath="//configuration/appSettings"
                              Name="add" Sequence='12'/>

                <util:XmlFile Id="UpdateElementXml4"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/appSettings/add[\[]not(@key)[\]]"
                              Name="key"
                              Value="DesignerAddress"
                              Sequence="13"/>

                <util:XmlFile Id="UpdateElementValueXml4"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/appSettings/add[\[]@key='DesignerAddress'[\]]"
                              Name="value"
                              Value="https://solutions.worldbank.org"
                              Sequence='14'/>
                <!--<add key="WebInterviewEnabled" value="true" />-->
                <util:XmlFile Id="CreateElementXml5"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="createElement"
                              ElementPath="//configuration/appSettings"
                              Name="add" Sequence='15'/>

                <util:XmlFile Id="UpdateElementXml5"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/appSettings/add[\[]not(@key)[\]]"
                              Name="key"
                              Value="WebInterviewEnabled"
                              Sequence="16"/>

                <util:XmlFile Id="UpdateElementValueXml5"
                              File="[CONFIGFOLDER]\Headquarters.Web.config"
                              Action="setValue"
                              ElementPath="//configuration/appSettings/add[\[]@key='WebInterviewEnabled'[\]]"
                              Name="value"
                              Value="true"
                              Sequence='17'/>
            </Component>
        </ComponentGroup>
    </Fragment>

    <Fragment>
        <UI>
        <Dialog Id="ConnectionStringDlg" Width="370" Height="270" Title="!(loc.ConnectionStringDlg_Title)">
            
            <Control Id="Next" Type="PushButton" X="236" Y="243" Width="56" Height="17" Default="yes" Text="!(loc.WixUINext)" />
            <Control Id="Back" Type="PushButton" X="180" Y="243" Width="56" Height="17" Text="!(loc.WixUIBack)" />
            <Control Id="Cancel" Type="PushButton" X="304" Y="243" Width="56" Height="17" Cancel="yes" Text="!(loc.WixUICancel)">
                <Publish Event="SpawnDialog" Value="CancelDlg">1</Publish>
            </Control>

            <Control Id="Description" Type="Text" X="25" Y="23" Width="280" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.ConnectionStringDlgDescription)" />
            
            <Control Id="Title" Type="Text" X="15" Y="6" Width="200" Height="15" Transparent="yes" NoPrefix="yes" Text="!(loc.ConnectionStringDlgTitle)" />
            <Control Id="BannerBitmap" Type="Bitmap" X="0" Y="0" Width="370" Height="44" TabSkip="no" Text="!(loc.ConnectionStringDlgBannerBitmap)" />
            
            <Control Id="BannerLine" Type="Line" X="0" Y="44" Width="370" Height="0" />
            <Control Id="BottomLine" Type="Line" X="0" Y="234" Width="370" Height="0" />

            <Control Id="ConnStringLabel" Type="Text" X="20" Y="60" Width="290" Height="30" NoPrefix="yes" Text="!(loc.ConnectionStringDlgLabel)" />

            <Control Id="CONNSERVERLabel" Type="Text" X="20" Y="102" Width="50" Height="18" NoPrefix="yes" Text="!(loc.ConnectionStringServerDlgLabel)" />
            <Control Id="CONNSERVERTextbox" Type="Edit" X="90" Y="100"  Height="18" Width="260" Property="CONNSERVER"  />

            <Control Id="CONNPORTLabel" Type="Text" X="20" Y="132" Width="50" Height="18" NoPrefix="yes" Text="!(loc.ConnectionStringPortDlgLabel)" />
            <Control Id="CONNPORTTextbox" Type="Edit" X="90" Y="130"  Height="18" Width="260" Property="CONNPORT"  />

            <Control Id="CONNUSERNAMELabel" Type="Text" X="20" Y="162" Width="50" Height="18" NoPrefix="yes" Text="!(loc.ConnectionStringUserNameDlgLabel)" />
            <Control Id="CONNUSERNAMETextbox" Type="Edit" X="90" Y="160"  Height="18" Width="260" Property="CONNUSERNAME"  />

            <Control Id="CONNPASSWORDLabel" Type="Text" X="20" Y="192" Width="50" Height="18" NoPrefix="yes" Text="!(loc.ConnectionStringPasswordDlgLabel)" />
            <Control Id="CONNPASSWORDTextbox" Type="Edit" X="90" Y="190" Height="18" Width="260" Property="CONNPASSWORD" Password="yes"/>

        </Dialog>
        </UI>
    </Fragment>
</Wix>
