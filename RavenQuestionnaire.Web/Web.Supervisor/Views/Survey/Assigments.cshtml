@using RavenQuestionnaire.Core.Views.Survey
@model SurveyGroupView
<script src="@Url.Content("~/Scripts/jquery.unobtrusive-ajax.min.js")" type = "text/javascript"> </script>
@{
    ViewBag.Title = "Surveys";
}
<script type="text/javascript">
    function HideForm(data) {
        var json = jQuery.parseJSON(data.responseText);
        $('#row-' + json.cqId).removeClass("showForm");

        if (json.userId != null && json.userName != null) {
            $('#link-' + json.cqId).replaceWith('<a id="link-' + json.cqId + '" href="/User/Details/' + json.userId + '">' + json.userName + '</a>');
        }
        else {
            $('#link-' + json.cqId).replaceWith('<a id="link-' + json.cqId + '" href="/User/Details/"></a>');
        }
    }
</script>
<h2>@(Model.SurveyTitle)'s assignments</h2>
<table class="table table-striped table-bordered table-condensed">
    <thead>
        <tr>
            @foreach (var header in Model.Headers)
            {
                <th>@header.Value</th>
            }
            <th>Responsible</th>
            <th>Status</th>
            <th></th>
        </tr>
    </thead>
    @foreach (SurveyGroupItem fitem in Model.Items)
    {
        <tr id="responsible-@(fitem.Id)">
            @foreach (var item in fitem.FeatureadValue)
            {
                <td>
                    @(string.IsNullOrEmpty(item.Value) ? string.Empty : item.Value)
                </td>
            }
            <td id="row-@fitem.Id">
                <div class="assignment-view">
                    <a id="link-@fitem.Id" href="@Url.Action("Details", "User", new { id = @fitem.Responsible == null ? string.Empty : fitem.Responsible.Id })">@(fitem.Responsible == null ? string.Empty : fitem.Responsible.Name)</a>
                </div>
                <div class="assignment-form">
                    @using (Ajax.BeginForm("AssignForm", "Survey", new AjaxOptions { OnComplete = "HideForm" }))
                    {
                        var id = fitem.Id + "";
                        @Html.Hidden("CqId", id)
                        <div>@Html.DropDownList("userId", ViewBag.Users as SelectList)</div>
                        <div>
                            <input class="btn btn-primary" name="Save" type="submit" value="Save" />
                            <input class="btn btn-danger" id="canc-@fitem.Id" name="Cancel" type="button" value="Cancel" />
                        </div>
                    }
                </div>
            </td>
            <td>@fitem.Status.Name
            </td>
            <td>
                @if (fitem.Responsible == null)
                {
                    <a href="@Url.Action("Assign", new { id = fitem.Id })">Assign</a>    
                }
                else
                {
                    <a id="ref-@fitem.Id" href="#" >Change</a>
                    <script type="text/javascript">
                        $('#ref-@(fitem.Id)').click(function () {
                            $('#row-@(fitem.Id)').addClass("showForm");
                        });
                        $('#canc-@(fitem.Id)').click(function () {
                            $('#row-@(fitem.Id)').removeClass("showForm");
                        });
                    </script>
                }
            </td>
        </tr>
    }
</table>
