@using System.Web.Script.Serialization
@using RavenQuestionnaire.Core.Entities.SubEntities
@using RavenQuestionnaire.Core.Views.Answer
@using RavenQuestionnaire.Core.Views.Question
@using RavenQuestionnaire.Core.Views.Questionnaire
@model QuestionnaireView
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var top = 0;
}
<link href="../../Content/themes/base/jquery.ui.resizable.css" rel="stylesheet" type="text/css" />
<link href="../../Content/jquery.jgrowl.css" rel="stylesheet" type="text/css" />
<style type="text/css">
    #canvas
    {
        height: 900px;
    }
    .canvas
    {
        position: relative;
        border: 1px solid red;
        margin: 0 auto;
        width: 80%;
    }
    
    .w
    {
        width: 12em;
        position: absolute;
        border: 1px solid black;
        z-index: 4;
        border-radius: 1em;
        border: 1px solid #0069D6;
        box-shadow: 2px 2px 19px #e0e0e0;
        -o-box-shadow: 2px 2px 19px #e0e0e0;
        -webkit-box-shadow: 2px 2px 19px #e0e0e0;
        -moz-box-shadow: 2px 2px 19px #e0e0e0;
        -moz-border-radius: 0.5em;
        border-radius: 0.5em;
        opacity: 0.8;
        filter: alpha(opacity=80);
        cursor: move;
        text-align: center;
    }
    .wi
    {
        margin: 1em;
        margin-bottom: 30px;
    }
    .canvas.w
    {
        width: 80%;
        padding: 0;
        padding-bottom: 20px;
    }
    .aLabel
    {
        background-color: white;
        opacity: 0.8;
        padding: 0.3em;
        z-index: 999;
    }
    .ep
    {
        position: absolute;
        bottom: 10px;
        left: 50%;
        margin-left: -8px;
        width: 16px;
        height: 16px;
        background-color: #C7EEFE;
        cursor: pointer;
    }
    .dragHover
    {
        box-shadow: 2px 2px 19px #0064CD;
        -o-box-shadow: 2px 2px 19px #0064CD;
        -webkit-box-shadow: 2px 2px 19px #0064CD;
        -moz-box-shadow: 2px 2px 19px #0064CD;
    }
    .highlight-error
    {
        box-shadow: 2px 2px 19px red;
        -o-box-shadow: 2px 2px 19px red;
        -webkit-box-shadow: 2px 2px 19px red;
        -moz-box-shadow: 2px 2px 19px red;
    }
</style>
@helper RenderQuestion(AbstractQuestionView question, FlowBlock block, string scope)
    {
        var id = question.PublicKey;
        var topPx = block.Top + "px";
        var leftPx = block.Left + "px";
        var heightPx = block.Height + "px";
        var widthPx = block.Width + "px";
        var templateId = "action" + question.PublicKey;
    <text>
    <div class="w" id="@id" style="top: @topPx; left: @leftPx; height: @heightPx; width:@widthPx" scope="@scope">
        <div class="wi">
            <div>@question.QuestionText</div>
        </div>
        <div class="ep">
        </div>
    </div>
    <script id="@templateId" type="text/x-jquery-tmpl">
            <div>
                <div>${Condition}</div>
                <a class="btn" data-ajax="true" 
                    data-ajax-method="POST" 
                    data-ajax-mode="replace" 
                    data-ajax-success="OpenModal" 
                    data-ajax-update="#editConnection" 
                    href="/Question/_GetAnswers?PublicKey=@(question.PublicKey)&QuestionnaireId=@(question.QuestionnaireId)&TargetPublicKey=${Target}">Edit</a>
            </div>
    </script>
    </text>
}
<script src="../../Scripts/jquery.jsPlumb-1.3.4-all-min.js" type="text/javascript"></script>
<script src="../../Scripts/modal.js" type="text/javascript"></script>
<script src="../../Scripts/jquery.tmpl.min.js" type="text/javascript"></script>
<script src="../../Scripts/jquery.jgrowl.min.js" type="text/javascript"></script>
<script src="../../Scripts/flow.js" type="text/javascript"></script>
<script>
    (function () {
        jsPlumbDemo.initConnections = function () {
            @if (Model.FlowGraph.Connections.Length != 0)
            {
                foreach (var connection in Model.FlowGraph.Connections)
                {
                    <text>
                    var connection = jsPlumb.connect({ source: "@connection.Source",target: "@connection.Target", scope:$("#@connection.Source").attr('scope')});
                    var p = { Target: "@connection.Target", Condition: "@Html.Raw(connection.LabelText)" };
                    connection.labelText = $("#action" + "@connection.Source").tmpl(p).html();
                    jsPlumbDemo.labelTexts[connection.id]="@Html.Raw(connection.LabelText)";
                    </text>
                }
            }
            jsPlumb.repaintEverything();
        };
    })();
    $('#editConnection').modal({
        backdrop: 'static'
    });
    function OpenModal() {
        $('#editConnection').modal('show');
    }
    function HideEditConditionForm(sourceId, targetId, answerId) {
        var options = {};
        var text = $('input:radio[value='+answerId+']').attr('text');
        options.scope = $("#" + sourceId).attr('scope');
        options.source = sourceId;
        options.target = targetId;
        jsPlumbDemo.updateConnectionLabel(options, text);
        
        $('#editConnection').modal('hide');
        SaveFlow();
    }
    function SaveFlow() {
        if (jsPlumbDemo.checkFlow() === true) {
            $.jGrowl("saving the flow", { theme: 'alert-message info' });
            $.ajax({
                    type: "POST",
                    url: "@Url.Action("_SaveFlow", "Questionnaire")",
                    data: JSON.stringify({ graphs: jsPlumbDemo.getAllFlowGraphs(), questionnaireId: @Model.Id }),
                    contentType: 'application/json, charset=utf-8',
                    statusCode: {
                        200: function(response) {
                            $.jGrowl(response.status, { theme: 'alert-message success' });
                        },
                        500: function(response) {
                            $.jGrowl("error");
                        }
                    }
                });
        }
        else {
            $.jGrowl("error", { theme: 'alert-message error' });
        }
    }
    $(document).ready(function() {
        $("#saveFlow").click(function () {
            SaveFlow();
            return false;
        });
        $("#checkFlow").click(function () {
           if (jsPlumbDemo.checkFlow()===true) {
               $.jGrowl("flow is ok", { theme: 'alert-message success' });
           }
            return false;
        });
        $("#repaintFlow").click(function () {
            jsPlumb.repaintEverything();
            return false;
        });
        
    });
</script>
<h1>@Model.Title</h1>
<a class="btn primary" href="#" id="saveFlow">Save</a> <a class="btn primary" href="#"
    id="checkFlow">Check flow</a>
    <a class="btn primary" href="#"
    id="repaintFlow">Repaint</a>
<div id="canvas" class="canvas">
    @foreach (var question in Model.Questions)
    {
        var block = Model.FlowGraph.Blocks.SingleOrDefault(b => b.QuestionId == question.PublicKey);
        <text>@RenderQuestion(question, block, "canvas")</text>
    }
    @if (Model.Groups.Length > 0)
    {
        foreach (var group in Model.Groups)
        {
            var canvasId = group.PublicKey.ToString();
            var gblock = Model.FlowGraph.Blocks.SingleOrDefault(b => b.QuestionId == group.PublicKey);
            var topPx = gblock.Top + "px";
            var leftPx = gblock.Left + "px";
            var heightPx = gblock.Height + "px";
            var widthPx = gblock.Width + "px";
            var templateId = "action" + group.PublicKey;
        <div id="@canvasId"  class="canvas w" scope="canvas" style="top: @topPx; left: @leftPx; height: @heightPx; width:@widthPx">
            <div>@group.GroupText</div>
            @foreach (var question in group.Questions)
            {
                var block = Model.FlowGraph.Blocks.SingleOrDefault(b => b.QuestionId == question.PublicKey);
                <text>@RenderQuestion(question, block, canvasId)</text>
            }
            <div class="ep">
            </div>
        </div>
        <text><script id="@templateId" type="text/x-jquery-tmpl"></script></text>
        }
    }
</div>
<div id="editConnection" class="modal hide fade">
</div>
<ul id="lst"></ul>
