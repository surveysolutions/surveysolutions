@using System.Web.Script.Serialization
@using RavenQuestionnaire.Core.Views.Answer
@using RavenQuestionnaire.Core.Views.Questionnaire
@model QuestionnaireView
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var top = 0;
}
<link href="../../Content/jquery.jgrowl.css" rel="stylesheet" type="text/css" />
<style type="text/css">
    #canvas
    {
        position: relative;
        width: 80%;
        height: 900px;
        border: 1px solid red;
        margin: 0 auto;
    }
    .w
    {
        width: 12em;
        padding: 1em;
        position: absolute;
        border: 1px solid black;
        z-index: 4;
        border-radius: 1em;
        border: 1px solid #0069D6;
        box-shadow: 2px 2px 19px #e0e0e0;
        -o-box-shadow: 2px 2px 19px #e0e0e0;
        -webkit-box-shadow: 2px 2px 19px #e0e0e0;
        -moz-box-shadow: 2px 2px 19px #e0e0e0;
        -moz-border-radius: 0.5em;
        border-radius: 0.5em;
        opacity: 0.8;
        filter: alpha(opacity=80);
        cursor: move;
        padding-bottom: 30px;
        text-align: center;
    }
    
    .aLabel
    {
        background-color: white;
        opacity: 0.8;
        padding: 0.3em;
    }
    .ep
    {
        position: absolute;
        bottom: 10px;
        left: 50%;
        margin-left: -8px;
        width: 16px;
        height: 16px;
        background-color: #C7EEFE;
        cursor: pointer;
    }
</style>
<script src="../../Scripts/jquery.jsPlumb-1.3.4-all-min.js" type="text/javascript"></script>
<script src="../../Scripts/modal.js" type="text/javascript"></script>
<script src="../../Scripts/jquery.tmpl.min.js" type="text/javascript"></script>
<script src="../../Scripts/jquery.jgrowl.min.js" type="text/javascript"></script>
<script src="../../Scripts/flow.js" type="text/javascript"></script>
<script>
    (function () {
        jsPlumbDemo.initConnections = function () {
            @if (Model.FlowGraph.Connections.Length != 0)
            {
                foreach (var connection in Model.FlowGraph.Connections)
                {
                    <text>
                    var connection = jsPlumb.connect({ source: "@connection.Source",target: "@connection.Target"});
                    var p = { Target: "@connection.Target", Condition: "@Html.Raw(connection.LabelText)" };
                    connection.labelText = $("#action" + "@connection.Source").tmpl(p).html();
                    jsPlumbDemo.labelTexts[connection.id]="@Html.Raw(connection.LabelText)";
                    </text>
                }
            }
            jsPlumb.repaintEverything();
        };
    })();
    $('#editConnection').modal({
        backdrop: 'static'
    });
    function OpenModal() {
        $('#editConnection').modal('show');
    }
    function HideEditConditionForm(content) {
        
        var response = $.parseJSON(content.responseText);
        if (response != null) {
            var options = {};
            options.source = response.sourceId;
            options.target = response.targetId;
            jsPlumbDemo.updateConnectionLabel(options, response.expression);
        }
        $('#editConnection').modal('hide');
        SaveFlow();
    }
    function SaveFlow() {
        $.jGrowl("saving the flow");
        $.ajax({
                type: "POST",
                url: "@Url.Action("_SaveFlow", "Questionnaire")",
                data: JSON.stringify({ Blocks: jsPlumbDemo.getAllBlocks(), Connections: jsPlumbDemo.getAllConnections(), QuestionnaireId: @Model.Id }),
                contentType: 'application/json, charset=utf-8',
                statusCode: {
                    200: function(response) {
                        $.jGrowl(response.status);
                    }
                }
            });
    }
    $(document).ready(function() {
        $("#saveFlow").click(function () {
            SaveFlow();
            return false;
        });
    });
</script>
<h1>@Model.Title</h1>
<a class="btn primary" href="#" id="saveFlow">Save</a>
<div id="canvas">
    @foreach (var question in Model.Questions)
    {
        var block = Model.FlowGraph.Blocks.SingleOrDefault(b => b.QuestionId == question.PublicKey);
        var id = question.PublicKey;
        var topPx = block.Top + "px";
        var leftPx = block.Left + "px";
        var templateId = "action" + question.PublicKey;
        <div class="w" id="@id" style="top: @topPx; left: @leftPx;">
            <div>@question.QuestionText</div>
            <div class="ep">
            </div>
        </div>
        <script id="@templateId" type="text/x-jquery-tmpl">
            <div>
                <div>${Condition}</div>
                <a class="btn" data-ajax="true" 
                    data-ajax-method="POST" 
                    data-ajax-mode="replace" 
                    data-ajax-success="OpenModal" 
                    data-ajax-update="#editConnection" 
                    href="/Question/_GetAnswers?PublicKey=@(question.PublicKey)&QuestionnaireId=@(question.QuestionnaireId)&TargetPublicKey=${Target}">Edit</a>
            </div>
        </script>
    }
</div>
<div id="editConnection" class="modal hide fade">
</div>
